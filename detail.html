<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Goal Tracker</title>
    <link rel="stylesheet" href="./css/default.css">
    <link rel="stylesheet" href="./css/stamp.css">
    <script type="text/javascript" src="./js/common.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
</head>

<body>

    <!-- ìƒë‹¨ ë©”ë‰´ -->
    <header>
        <div class="header-left">Goal Tracker</div>
    </header>

    <div id="tracker-detail" class="tracker-detail page">
        <input type="hidden" id="selected-step" value="">

        <!-- ìƒë‹¨ íƒ­ -->
        <div class="tab-header" data-html2canvas-ignore>
            <button class="tab-btn active" data-tab="stamp">ìŠ¤íƒ¬í”„ ë³´ê¸°</button>
            <button class="tab-btn" data-tab="list">ë¦¬ìŠ¤íŠ¸ ë³´ê¸°</button>
        </div>

        <!-- íƒ­ ì½˜í…ì¸  -->
        <div class="tab-content" id="tab-stamp">
            <div class="tab-content-header">
                <h2 id="stamp_nm"></h2>
                <div class="tab-action-buttons" style="display: none;">
                    <button id="memo-add-btn" class="tab-action-btn" onclick="openMemoModal()">ë©”ëª¨ì¶”ê°€</button>
                    <button id="undo-btn" class="tab-action-btn" onclick="undoCompleteAction()">ë˜ëŒë¦¬ê¸°</button>
                </div>
            </div>
            <canvas id="canvas" style="display:none;"></canvas>
            <div class="grid" id="stamp-grid">
                <!-- JSë¡œ n*n ì¹¸ ìƒì„± -->
            </div>
            <div class="tab-content-bottom">
                <button id="share-btn" class="tab-action-btn" data-html2canvas-ignore>ê³µìœ í•˜ê¸°</button>
            </div>
        </div>

        <!-- ë‘ ë²ˆì§¸ íƒ­: ë¦¬ìŠ¤íŠ¸ ë³´ê¸° -->
        <div class="tab-content" id="tab-list" style="display:none;">
            <h2>ë‹¬ì„± ê¸°ë¡</h2>
            <div class="record-list"></div>
        </div>
    </div>

    <!-- ë©”ëª¨ ìˆ˜ì • ëª¨ë‹¬ -->
    <div id="memo-modal" class="memo-modal">
        <div class="memo-modal-content">
            <div class="memo-modal-header">
                <h3>ë©”ëª¨ ìˆ˜ì •</h3>
                <span class="memo-close-btn" onclick="closeMemoModal()">&times;</span>
            </div>
            <textarea id="memo-input" rows="4" maxlength="500"></textarea>
            <div class="memo-modal-bottom">
                <div class="memo-char-count" id="memo-char-count">(0/500)</div>
                <button id="memo-save" class="memo-save-btn">
                    ì €ì¥
                </button>
            </div>
        </div>
    </div>

    <div class="alert-modal" id="alert-modal" style="display:none;">
        <div class="alert-content">
            <p id="alert-message">íŒì—… ì˜ˆì‹œ.</p>
            <button id="alert-close" onclick="hideAlert()">í™•ì¸</button>
        </div>
    </div>

    <!-- í­ì£½ ì• ë‹ˆë©”ì´ì…˜ ì»¨í…Œì´ë„ˆ -->
    <div id="firework-container" class="firework-container"></div>

    <!-- í•˜ë‹¨ ë„¤ë¹„ê²Œì´ì…˜ -->
    <nav class="bottom-nav">
        <button class="nav-item active" onclick="location.href='./index.html'">
            <span>ğŸ </span>
            <span class="label">í™ˆ</span>
        </button>
        <button class="nav-item" onclick="location.href='./setting.html'">
            <span>âš™ï¸</span>
            <span class="label">ì„¤ì •</span>
        </button>
    </nav>

    <script>
        let stampInfo = {}; // ìŠ¤íƒ¬í”„ ê¸°ë³¸ ì •ë³´ 
        let stampRecords = {}; // ìŠ¤íƒ¬í”„ ê° ì†ì„± ë³„ ê¸°ë³¸ ì •ë³´ 
        let isComplete = false; // ìŠ¤íƒ¬í”„ ì™„ì„± ì—¬ë¶€
        const selectedStep = document.getElementById("selected-step");
        const tabActionBtn = document.querySelector(".tab-action-buttons");
        const memoCharCount = document.getElementById('memo-char-count'); // ë¬¸ì ìˆ˜ ì¹´ìš´í„°
        const params = new URLSearchParams(window.location.search);
        const stampId = params.get('stamp_id');

        // document.ready 
        document.addEventListener('DOMContentLoaded', function () {
            console.log('Document is ready with vanilla JavaScript!');

            if (!stampId) {
                showAlert("ì˜ëª»ëœ ì ‘ê·¼ì…ë‹ˆë‹¤. ë‹¤ì‹œ ë¡œê·¸ì¸í•´ì£¼ì„¸ìš”.", () => {
                    location.href = './login.html';
                });
                return;
            }

            drawStampArea();
        });

        // íƒ­ ì „í™˜
        document.querySelectorAll(".tab-btn").forEach(btn => {
            btn.addEventListener("click", () => {
                document.querySelectorAll(".tab-btn").forEach(b => b.classList.remove("active"));
                document.querySelectorAll(".tab-content").forEach(c => c.style.display = "none");

                btn.classList.add("active");
                const tabId = btn.dataset.tab;
                document.getElementById("tab-" + tabId).style.display = "block";

                if(tabId === "list"){
                    renderRecords();
                }else if(tabId === "stamp"){
                    renderGrids();
                }
            });
        });

        function drawStampArea() {
            apiFetch(`${ctx}/stamp?stamp_id=${stampId}`, {
                method: 'GET'
            })
            .then(data => {
                stampInfo = data;
                if(stampInfo.progress_cnt >= stampInfo.total_cnt){
                    isComplete = true;
                }
                apiFetch(`${ctx}/stamp/record?stamp_id=${stampInfo.stamp_id}`, {
                    method: 'GET'
                }).then(data => {
                    stampRecords = data;
                    document.getElementById("stamp_nm").innerText = stampInfo.stamp_nm;
                    renderGrids();
                    renderRecords();
                    // ìŠ¤íƒ¬í”„ ì™„ì„±í–ˆì„ ë•Œ ì´ë²¤íŠ¸
                    if(isComplete){
                        showAlert("ì¶•í•˜í•©ë‹ˆë‹¤! ìŠ¤íƒ¬í”„ë¥¼ ëª¨ë‘ ì™„ì„±í•˜ì…¨ìŠµë‹ˆë‹¤! ğŸ‰");
                        launchFireworks();
                    }
                }).catch(error => {
                    console.error('Error:', error);
                    showAlert("ìŠ¤íƒ¬í”„ ìƒì„¸ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨í•˜ì˜€ìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.");
                });
            })
            .catch(error => {
                console.error('Error:', error);
                showAlert("ìŠ¤íƒ¬í”„ ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨í•˜ì˜€ìŠµë‹ˆë‹¤. ë‹¤ì‹œ ë¡œê·¸ì¸í•´ì£¼ì„¸ìš”.", () => {
                    location.href = './login.html';
                });
                return;
            });
            
        }

        // ìŠ¤íƒ¬í”„ ê·¸ë¦¬ë“œ ìƒì„±
        function renderGrids() {
            const grid = document.getElementById("stamp-grid");
            let total = stampInfo.total_cnt;

            let countOfCols;
            if(total < 10){
                countOfCols = total;
            }else{
                countOfCols = Math.ceil(Math.sqrt(total));
                countOfCols = countOfCols > 10 ? 10 : countOfCols;
            }
            document.querySelector('.grid').style.setProperty('--count-of-cols', countOfCols);

            const records = stampRecords.data ?? [];
            grid.innerHTML = '';

            for (const r of records) {
                const cell = document.createElement("div");
                cell.className = "cell";
                if (r.is_complete) {
                    cell.classList.add("completed");
                }
                cell.style.backgroundImage = `url('${r.is_complete ? stampInfo.after_image_url : stampInfo.before_image_url}')`;
                if(!isComplete){
                    cell.addEventListener("click", () => {
                        if (!cell.classList.contains("completed")) {
                            // ìŠ¤íƒ¬í”„ë¥¼ ì°¨ë¡€ëŒ€ë¡œ ëˆŒë €ì„ ë•Œë§Œ ì™„ë£Œ ì²˜ë¦¬ 
                            if(r.step !== 1 && !records[r.step - 2].is_complete) {
                                showAlert("ì´ì „ ìŠ¤íƒ¬í”„ë¶€í„° ì°¨ë¡€ëŒ€ë¡œ ëˆŒëŸ¬ì£¼ì„¸ìš”.");
                                return;
                            }
    
                            cell.classList.add("completed");
                            cell.style.backgroundImage = `url('${stampInfo.after_image_url}')`;
                            r.is_complete = true;
                            selectedStep.value = r.step - 1;
                            updateStampRecords();
                        }else{
                            selectedStep.value = r.step - 1;
                            tabActionBtn.style.display = "flex";
                        }
                    });
                }
                grid.appendChild(cell);
            }
        }

        // ë¦¬ìŠ¤íŠ¸ ë Œë”ë§
        function renderRecords() {
            const recordList = document.querySelector(".record-list");
            recordList.innerHTML = "";
            stampRecords.data.forEach((r, i) => {
                const div = document.createElement("div");
                div.className = "record-item";
                div.dataset.index = i;
                div.innerHTML = `
                        <div class="thumbnail" style="background-image:url('${r.is_complete ? stampInfo.after_image_url : stampInfo.before_image_url}')"></div>
                        <div class="content">
                            <div class="title">${r.step}ì¼ì§¸</div>
                            <div class="memo-text">${r.memo || "ë©”ëª¨ ì—†ìŒ"}</div>
                        </div>
                        `;
                recordList.appendChild(div);
            });
            
            if(!isComplete){
                recordList.addEventListener("click", (e) => {
                    const item = e.target.closest(".record-item");
                    if (!item) return;
    
                    if(stampRecords.data[item.dataset.index].is_complete){
                        selectedStep.value = item.dataset.index;
                        openMemoModal();
                    }
                });
            }
        }

        // ìŠ¤íƒ¬í”„ ê¸°ë¡ ì—…ë°ì´íŠ¸ 
        function updateStampRecords(){
            const step = selectedStep.value;
            const record = stampRecords.data[step];
            const progress_cnt = stampRecords.data.filter(r => r.is_complete).length;
            
            apiFetch(`${ctx}/stamp/progress`, {
                method: 'PUT',
                body: JSON.stringify({
                    stamp_id: stampInfo.stamp_id,
                    progress_cnt: progress_cnt,
                    ...record
                })
            }).then(data => {
                console.log('Success:', data);
                drawStampArea();
            }).catch(error => {
                console.error('Error:', error);
                showAlert("ìŠ¤íƒ¬í”„ ê¸°ë¡ ì—…ë°ì´íŠ¸ì— ì‹¤íŒ¨í•˜ì˜€ìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.");
            });
        }

        // ë°”ê¹¥ í´ë¦­ ì‹œ tab ì½˜í…ì¸  ì˜ì—­ ë²„íŠ¼ ìˆ¨ê¸°ê¸°
        document.addEventListener("click", (e) => {
            if (!e.target.closest(".cell")) {
                tabActionBtn.style.display = "none";
            }
        });
      
        // ë˜ëŒë¦¬ê¸° ë²„íŠ¼ í´ë¦­ ì‹œ 
        function undoCompleteAction(){
            const step = selectedStep.value;
            const record = stampRecords.data[step];
            // ìŠ¤íƒ¬í”„ë¥¼ ì°¨ë¡€ëŒ€ë¡œ ëˆŒë €ì„ ë•Œë§Œ ì·¨ì†Œ ì²˜ë¦¬ 
            if(record.step !== stampRecords.data.length && stampRecords.data[record.step].is_complete) {
                showAlert("ìµœê·¼ ìŠ¤íƒ¬í”„ë¶€í„° ì°¨ë¡€ëŒ€ë¡œ ëˆŒëŸ¬ì£¼ì„¸ìš”.");
                return;
            }
            if (record.is_complete) {
                record.is_complete = false;
                record.memo = null;
                updateStampRecords();
            }
        }

        document.getElementById("share-btn").addEventListener("click", async () => {
            tabActionBtn.style.display = "none";
            const element = document.getElementById("tracker-detail");
            
            const canvas = await html2canvas(element, {
                useCORS: true,        // CORS í—ˆìš©
                allowTaint: false,     // ì´ë¯¸ì§€ë¥¼ ê¹¨ë—í•˜ê²Œ ì²˜ë¦¬
                scale: 2               // í•´ìƒë„ í–¥ìƒ
            });
            const dataUrl = canvas.toDataURL("image/png");

            // dataUrl = base64 ì´ë¯¸ì§€
            console.log(dataUrl);
                    
            // ë‹¤ìš´ë¡œë“œ ë§í¬ ìƒì„±(í…ŒìŠ¤íŠ¸)
            const link = document.createElement("a");
            link.href = dataUrl;
            link.download = "stamp-board.png"; // ì €ì¥ë  íŒŒì¼ëª…
            link.click();
        });

        // ë©”ëª¨ ëª¨ë‹¬ ê´€ë ¨
        const modal = document.getElementById("memo-modal");
        const memoInput = document.getElementById("memo-input");
        const saveBtn = document.getElementById("memo-save");

        // ë©”ëª¨ ëª¨ë‹¬ ì—´ê¸°
        function openMemoModal() {
            memoInput.value = stampRecords.data[selectedStep.value].memo;
            memoCharCount.textContent = `(${memoInput.value.length}/500)`;
            modal.classList.add('show');
        }

        // ëª¨ë‹¬ ë‹«ê¸°
        function closeMemoModal(){
            modal.classList.remove('show');
        }

        // ë©”ëª¨ ì €ì¥
        saveBtn.addEventListener("click", () => {
            stampRecords.data[selectedStep.value].memo = memoInput.value;
            closeMemoModal();
            updateStampRecords();
        });

        // ë¬¸ì ìˆ˜ ì¹´ìš´í„°
        memoInput.addEventListener('input', function() {
            memoCharCount.textContent = `(${memoInput.value.length}/500)`;
        });

        // í­ì£½ ì• ë‹ˆë©”ì´ì…˜ ê´€ë ¨
        function launchFireworks() {
          const container = document.getElementById('firework-container');
          if (!container) return;
          const colors = ['#ff7aa2', '#ffd700', '#7adfff', '#ffb347', '#b47aff', '#7affb4', '#ff7a7a'];
          const num = 18;
          for (let i = 0; i < num; i++) {
            const angle = (2 * Math.PI * i) / num;
            const x = Math.cos(angle) * (window.innerWidth * 0.48); // ë” í¬ê²Œ
            const y = -Math.abs(Math.sin(angle) * (window.innerHeight * 0.45) + 80); // ë” ìœ„ë¡œ
            const firework = document.createElement('div');
            firework.className = 'firework';
            firework.style.background = colors[i % colors.length];
            firework.style.setProperty('--x', `${x}px`);
            firework.style.setProperty('--y', `${y}px`);
            firework.style.left = `calc(50% + ${Math.random()*60-30}px)`;
            firework.style.width = '16px';
            firework.style.height = '16px';
            container.appendChild(firework);
            setTimeout(() => firework.remove(), 1400);
          }
        }

    </script>

</body>

</html>