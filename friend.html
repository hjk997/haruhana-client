<!DOCTYPE html>
<html lang="ko">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Goal Tracker</title>
  <link rel="stylesheet" href="./css/default.css">
  <script type="text/javascript" src="./js/common.js"></script>
</head>

<body>

  <!-- 상단 메뉴 -->
  <header>
    <div class="header-left">Goal Tracker</div>
  </header>

  <div class="list-container">
    <!-- 친구 추가 [S] -->
    <h3 class="section-title">친구추가</h3>
    <div class="search-bar">
        <input type="text" id="search-input" placeholder="추가할 친구의 ID 또는 이름을 입력해주세요." autocomplete="off"/>
        <button class="clear-btn" id="search-clear-btn" aria-label="검색 취소" type="button" onclick="javascript:switchList('friend')">&times;</button>
        <button id="search-btn" class="search-btn" aria-label="검색" type="button">
            <span class="search-icon">&#128269;</span>
        </button>
    </div>
    <!-- 친구 추가 [E] -->
    <hr class="section-divider">
    <h3 class="section-title">친구목록</h3>
    <div class="friend-list-header">
      <!-- 친구 수 텍스트 추가 [S] -->
      <div class="friend-count">
          <span class="friend-count-num">0</span>명
      </div>
      <!-- 친구 목록 상단에 버튼 3개 추가 -->
      <div id="friend-list-filter" class="friend-list-filter">
        <button class="friend-filter-btn active" data-status="ACCEPTED">전체 친구</button>
        <button class="friend-filter-btn" data-status="RECEIVED">받은 요청</button>
        <button class="friend-filter-btn" data-status="PENDING">보낸 요청</button>
      </div>
    </div>
    
    <!-- 친구 수 텍스트 추가 [E] -->
    <!-- 친구 목록 [S] -->
    <div class="list">
        <div id="friend-list"></div>
        <div id="search-list"></div>
    </div>
    <!-- 친구 목록 없을 때 -->
    <div class="list empty" style="display:none;">
      <div class="empty-message">
        <span class="empty-icon">📄</span>
        <span id="empty-span-message"></span>
      </div>
    </div>
    <!-- 친구 목록 [E] -->
  </div>

  <!-- 하단 네비게이션 -->
  <nav class="bottom-nav">
    <button class="nav-item active" onclick="location.href='./index.html'">
      <span>🏠</span>
      <span class="label">홈</span>
    </button>
    <button class="nav-item" onclick="location.href='./setting.html'">
      <span>⚙️</span>
      <span class="label">설정</span>
    </button>
  </nav>
  
  <div class="alert-modal" id="alert-modal" style="display:none;">
    <div class="alert-content">
        <p id="alert-message">팝업 예시</p>
        <button id="alert-close" onclick="hideAlert()">확인</button>
    </div>
  </div>
  <script>
    const friendList = document.getElementById('friend-list');
    const searchList = document.getElementById('search-list');
    const tabContainer = document.getElementById("friend-list-filter");

    const messageObject = {
      "ACCEPTED": {
        "empty": "친구 목록이 없습니다.",
        "delete_confirm": "친구 상태를 해제하시겠습니까?",
        "status": "친구"
      },
      "RECEIVED": {
        "empty": "받은 친구 요청이 없습니다.",
        "delete_confirm": "친구 요청을 취소하시겠습니까?",
        "status": "친구 요청 중"
      },
      "PENDING": {
        "empty": "보낸 친구 요청이 없습니다.",
        "delete_confirm": "친구 요청을 취소하시겠습니까?",
        "status": "요청 대기 중"
      },
    }

    // document.ready 
    document.addEventListener('DOMContentLoaded', function () {
      console.log('Document is ready with vanilla JavaScript!');
      callFriendList();
    });

    // <script> 내부에 추가
    document.querySelectorAll('.friend-filter-btn').forEach(btn => {
      btn.addEventListener('click', function() {
        document.querySelectorAll('.friend-filter-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        // status에 따라 친구 목록 불러오기
        callFriendList();
      });
    });

    function callFriendList(){
      const status = document.querySelector('.friend-filter-btn.active').dataset.status;
      apiFetch(`${ctx}/friend/list?status=${status}`, {
            method: 'GET',
        })
        .then(data => {
          console.log(data);
          drawFriendList(data);
        })
        .catch(error => {
          console.error('Error:', error);
          showAlert("친구 목록을 불러오기 실패하였습니다.", () =>{
            location.href = './index.html';
          });
          return;
        });
    }

    // 친구 목록 그리기
    function drawFriendList(data){
      switchList('friend');

      const listContainer = document.querySelector(".list");
      const emptyContainer = document.querySelector(".list.empty");
      const status = document.querySelector('.friend-filter-btn.active').dataset.status;
      document.querySelector(".friend-count-num").innerText = data.length;

      // 기존 목록 초기화
      friendList.innerHTML = '';

      if (!data || data.length === 0) {
        emptyContainer.style.display = "flex";
        listContainer.style.display = "none";
        document.getElementById("empty-span-message").innerText = messageObject[status].empty;
        return;
      } else {
        emptyContainer.style.display = "none";
        listContainer.style.display = "block";
      }

      data.forEach(friend => {
        let html = `
          <div class="list-item">
            <div class="thumbnail"></div>
            <div class="info">
              <div class="title">${friend.friend_user_nm}</div>
            </div>
            <input type="hidden" name="user_id" value="${friend.friend_user_id}" />
            `
        if(friend.friend_status === 'PENDING'){
          html += `<span class="badge badge-pending">수락 대기중</span>
            <button class="close-btn" aria-label="삭제">×</button>`;
        }else if(friend.friend_status === 'RECEIVED'){
          html += `<span class="badge badge-received">친구 요청</span>
          <button class="accept-btn" aria-label="수락">&#10004;</button>
          <button class="close-btn" aria-label="삭제">×</button>`;
        }else if(friend.friend_status === 'ACCEPTED'){
          html += `<button class="close-btn" aria-label="삭제">×</button>`;
        }
          html+=  `
          </div>
        `;
        friendList.insertAdjacentHTML('beforeend', html);
        // const lastItem = listContainer.lastElementChild;
        // lastItem.querySelector(".thumbnail").style.backgroundImage = `url(${friend.image_url})`;
      });

      // 닫기 버튼 클릭 시 친구 삭제 
      friendList.querySelectorAll('.close-btn').forEach(item => {
        item.addEventListener('click', function(e) {
          showAlert(`${messageObject[status].delete_confirm}`, () => {
            apiFetch(`${ctx}/friend/delete`, {
                method: 'DELETE',
                body: JSON.stringify({
                    friend_user_id: item.parentElement.querySelector('input[name="user_id"]').value
                }),
            }).then(data => {
                console.log(data);
                hideAlert();
                callFriendList();
            });
          });
        });
      });

      // 수락 버튼 클릭 시 친구 수락
      friendList.querySelectorAll('.accept-btn').forEach(item => {
        item.addEventListener('click', function(e) {
          apiFetch(`${ctx}/friend/status`, {
                method: 'PUT',
                body: JSON.stringify({
                    friend_user_id: item.parentElement.querySelector('input[name="user_id"]').value,
                    friend_status: 'ACCEPTED'
                }),
            }).then(data => {
                console.log(data);
                showAlert("친구 신청을 수락하였습니다!", () =>{
                  hideAlert();
                  callFriendList();
                });
            });
        });
      });
    }

    document.getElementById('search-input').onkeypress = function (e) {
      if (!e) e = window.event;
      const keyCode = e.keyCode || e.which;
      if (keyCode == '13') {
        e.preventDefault();
        searchUser();
        return false;
      }
    };

    document.getElementById('search-btn').addEventListener('click', () => {
        searchUser();
    });

    function searchUser(){
        const query = document.getElementById('search-input').value;
        if(!query || query.trim() === ''){
            switchList('friend');
            return;
        }

        apiFetch(`${ctx}/friend/searchuser?query=${query}`, {
                method: 'GET',
            })
            .then(data => {
                console.log(data);
                drawSearchList(data);
            })
            .catch(error => {
                console.error('Error:', error);
                showAlert("사용자 검색에 실패하였습니다.", () =>{
                    location.href = './index.html';
                });
                return;
            });

    }

    function drawSearchList(data){
        switchList('search');
        
      const listContainer = document.querySelector(".list");
      const emptyContainer = document.querySelector(".list.empty");
      document.querySelector(".friend-count-num").innerText = data.length;

      if (!data || data.length === 0) {
        emptyContainer.style.display = "flex";
        listContainer.style.display = "none";
        document.getElementById("empty-span-message").innerText = "검색 결과가 없습니다.";
        return;
      } else {
        emptyContainer.style.display = "none";
        listContainer.style.display = "block";
      }

      searchList.innerHTML = '';

      data.forEach(user => {
        let html = `
          <div class="list-item">
            <div class="thumbnail"></div>
            <div class="info">
              <div class="title">${user.user_nm}</div>
            </div>
            <input type="hidden" name="user_id" value="${user.user_id}" />`;
            
        if(user.friend_status){
          html += `<span class="badge badge-friend">${messageObject[user.friend_status].status}</span>`;
        }else{
          html += `<button class="accept-btn" aria-label="친구신청하기">+</button>`;
        }
        html += `</div>`;
        searchList.insertAdjacentHTML('beforeend', html);
        // const lastItem = listContainer.lastElementChild;
        // lastItem.querySelector(".thumbnail").style.backgroundImage = `url(${friend.image_url})`;
      });

      // 추가 버튼 클릭 시 친구 요청
      searchList.querySelectorAll('.accept-btn').forEach(item => {
        item.addEventListener('click', function(e) {
          apiFetch(`${ctx}/friend`, {
                method: 'POST',
                body: JSON.stringify({
                    friend_user_id: item.parentElement.querySelector('input[name="user_id"]').value
                }),
            }).then(data => {
                console.log(data);
                showAlert("친구 신청을 전송하였습니다!", () =>{
                  hideAlert();
                  callFriendList();
                });
            });
        });
      });

    }

    // 리스트 전환 (친구 목록 / 검색 목록)
    function switchList(flag){
        if(flag === 'friend'){
            friendList.style.display = 'block';
            searchList.style.display = 'none';
            tabContainer.style.display = 'flex';
        } else if (flag === 'search'){
            friendList.style.display = 'none';
            searchList.style.display = 'block';
            tabContainer.style.display = 'none';
        }
    }

  </script>
</body>

</html>