<!DOCTYPE html>
<html lang="ko">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Goal Tracker</title>
  <link rel="stylesheet" href="./css/default.css">
  <script type="text/javascript" src="./js/common.js"></script>
</head>

<body>

  <!-- ìƒë‹¨ ë©”ë‰´ -->
  <header>
    <div class="header-left">Goal Tracker</div>
  </header>

  <div class="list-container">
    <!-- ì¹œêµ¬ ì¶”ê°€ [S] -->
    <h3 class="section-title">ì¹œêµ¬ì¶”ê°€</h3>
    <div class="search-bar">
        <input type="text" id="search-input" placeholder="ì¶”ê°€í•  ì¹œêµ¬ì˜ ID ë˜ëŠ” ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”." autocomplete="off"/>
        <button class="clear-btn" id="search-clear-btn" aria-label="ê²€ìƒ‰ ì·¨ì†Œ" type="button" onclick="javascript:switchList('friend')">&times;</button>
        <button id="search-btn" class="search-btn" aria-label="ê²€ìƒ‰" type="button">
            <span class="search-icon">&#128269;</span>
        </button>
    </div>
    <!-- ì¹œêµ¬ ì¶”ê°€ [E] -->
    <hr class="section-divider">
    <h3 class="section-title">ì¹œêµ¬ëª©ë¡</h3>
    <div class="friend-list-header">
      <!-- ì¹œêµ¬ ìˆ˜ í…ìŠ¤íŠ¸ ì¶”ê°€ [S] -->
      <div class="friend-count">
          <span class="friend-count-num">0</span>ëª…
      </div>
      <!-- ì¹œêµ¬ ëª©ë¡ ìƒë‹¨ì— ë²„íŠ¼ 3ê°œ ì¶”ê°€ -->
      <div id="friend-list-filter" class="friend-list-filter">
        <button class="friend-filter-btn active" data-status="ACCEPTED">ì „ì²´ ì¹œêµ¬</button>
        <button class="friend-filter-btn" data-status="RECEIVED">ë°›ì€ ìš”ì²­</button>
        <button class="friend-filter-btn" data-status="PENDING">ë³´ë‚¸ ìš”ì²­</button>
      </div>
    </div>
    
    <!-- ì¹œêµ¬ ìˆ˜ í…ìŠ¤íŠ¸ ì¶”ê°€ [E] -->
    <!-- ì¹œêµ¬ ëª©ë¡ [S] -->
    <div class="list">
        <div id="friend-list"></div>
        <div id="search-list"></div>
    </div>
    <!-- ì¹œêµ¬ ëª©ë¡ ì—†ì„ ë•Œ -->
    <div class="list empty" style="display:none;">
      <div class="empty-message">
        <span class="empty-icon">ğŸ“„</span>
        <span id="empty-span-message"></span>
      </div>
    </div>
    <!-- ì¹œêµ¬ ëª©ë¡ [E] -->
  </div>

  <!-- í•˜ë‹¨ ë„¤ë¹„ê²Œì´ì…˜ -->
  <nav class="bottom-nav">
    <button class="nav-item active" onclick="location.href='./index.html'">
      <span>ğŸ </span>
      <span class="label">í™ˆ</span>
    </button>
    <button class="nav-item" onclick="location.href='./setting.html'">
      <span>âš™ï¸</span>
      <span class="label">ì„¤ì •</span>
    </button>
  </nav>
  
  <div class="alert-modal" id="alert-modal" style="display:none;">
    <div class="alert-content">
        <p id="alert-message">íŒì—… ì˜ˆì‹œ</p>
        <button id="alert-close" onclick="hideAlert()">í™•ì¸</button>
    </div>
  </div>
  <script>
    const friendList = document.getElementById('friend-list');
    const searchList = document.getElementById('search-list');
    const tabContainer = document.getElementById("friend-list-filter");

    const messageObject = {
      "ACCEPTED": {
        "empty": "ì¹œêµ¬ ëª©ë¡ì´ ì—†ìŠµë‹ˆë‹¤.",
        "delete_confirm": "ì¹œêµ¬ ìƒíƒœë¥¼ í•´ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?",
        "status": "ì¹œêµ¬"
      },
      "RECEIVED": {
        "empty": "ë°›ì€ ì¹œêµ¬ ìš”ì²­ì´ ì—†ìŠµë‹ˆë‹¤.",
        "delete_confirm": "ì¹œêµ¬ ìš”ì²­ì„ ì·¨ì†Œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?",
        "status": "ì¹œêµ¬ ìš”ì²­ ì¤‘"
      },
      "PENDING": {
        "empty": "ë³´ë‚¸ ì¹œêµ¬ ìš”ì²­ì´ ì—†ìŠµë‹ˆë‹¤.",
        "delete_confirm": "ì¹œêµ¬ ìš”ì²­ì„ ì·¨ì†Œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?",
        "status": "ìš”ì²­ ëŒ€ê¸° ì¤‘"
      },
    }

    // document.ready 
    document.addEventListener('DOMContentLoaded', function () {
      console.log('Document is ready with vanilla JavaScript!');
      callFriendList();
    });

    // <script> ë‚´ë¶€ì— ì¶”ê°€
    document.querySelectorAll('.friend-filter-btn').forEach(btn => {
      btn.addEventListener('click', function() {
        document.querySelectorAll('.friend-filter-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        // statusì— ë”°ë¼ ì¹œêµ¬ ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸°
        callFriendList();
      });
    });

    function callFriendList(){
      const status = document.querySelector('.friend-filter-btn.active').dataset.status;
      apiFetch(`${ctx}/friend/list?status=${status}`, {
            method: 'GET',
        })
        .then(data => {
          console.log(data);
          drawFriendList(data);
        })
        .catch(error => {
          console.error('Error:', error);
          showAlert("ì¹œêµ¬ ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨í•˜ì˜€ìŠµë‹ˆë‹¤.", () =>{
            location.href = './index.html';
          });
          return;
        });
    }

    // ì¹œêµ¬ ëª©ë¡ ê·¸ë¦¬ê¸°
    function drawFriendList(data){
      switchList('friend');

      const listContainer = document.querySelector(".list");
      const emptyContainer = document.querySelector(".list.empty");
      const status = document.querySelector('.friend-filter-btn.active').dataset.status;
      document.querySelector(".friend-count-num").innerText = data.length;

      // ê¸°ì¡´ ëª©ë¡ ì´ˆê¸°í™”
      friendList.innerHTML = '';

      if (!data || data.length === 0) {
        emptyContainer.style.display = "flex";
        listContainer.style.display = "none";
        document.getElementById("empty-span-message").innerText = messageObject[status].empty;
        return;
      } else {
        emptyContainer.style.display = "none";
        listContainer.style.display = "block";
      }

      data.forEach(friend => {
        let html = `
          <div class="list-item">
            <div class="thumbnail"></div>
            <div class="info">
              <div class="title">${friend.friend_user_nm}</div>
            </div>
            <input type="hidden" name="user_id" value="${friend.friend_user_id}" />
            `
        if(friend.friend_status === 'PENDING'){
          html += `<span class="badge badge-pending">ìˆ˜ë½ ëŒ€ê¸°ì¤‘</span>
            <button class="close-btn" aria-label="ì‚­ì œ">Ã—</button>`;
        }else if(friend.friend_status === 'RECEIVED'){
          html += `<span class="badge badge-received">ì¹œêµ¬ ìš”ì²­</span>
          <button class="accept-btn" aria-label="ìˆ˜ë½">&#10004;</button>
          <button class="close-btn" aria-label="ì‚­ì œ">Ã—</button>`;
        }else if(friend.friend_status === 'ACCEPTED'){
          html += `<button class="close-btn" aria-label="ì‚­ì œ">Ã—</button>`;
        }
          html+=  `
          </div>
        `;
        friendList.insertAdjacentHTML('beforeend', html);
        // const lastItem = listContainer.lastElementChild;
        // lastItem.querySelector(".thumbnail").style.backgroundImage = `url(${friend.image_url})`;
      });

      // ë‹«ê¸° ë²„íŠ¼ í´ë¦­ ì‹œ ì¹œêµ¬ ì‚­ì œ 
      friendList.querySelectorAll('.close-btn').forEach(item => {
        item.addEventListener('click', function(e) {
          showAlert(`${messageObject[status].delete_confirm}`, () => {
            apiFetch(`${ctx}/friend/delete`, {
                method: 'DELETE',
                body: JSON.stringify({
                    friend_user_id: item.parentElement.querySelector('input[name="user_id"]').value
                }),
            }).then(data => {
                console.log(data);
                hideAlert();
                callFriendList();
            });
          });
        });
      });

      // ìˆ˜ë½ ë²„íŠ¼ í´ë¦­ ì‹œ ì¹œêµ¬ ìˆ˜ë½
      friendList.querySelectorAll('.accept-btn').forEach(item => {
        item.addEventListener('click', function(e) {
          apiFetch(`${ctx}/friend/status`, {
                method: 'PUT',
                body: JSON.stringify({
                    friend_user_id: item.parentElement.querySelector('input[name="user_id"]').value,
                    friend_status: 'ACCEPTED'
                }),
            }).then(data => {
                console.log(data);
                showAlert("ì¹œêµ¬ ì‹ ì²­ì„ ìˆ˜ë½í•˜ì˜€ìŠµë‹ˆë‹¤!", () =>{
                  hideAlert();
                  callFriendList();
                });
            });
        });
      });
    }

    document.getElementById('search-input').onkeypress = function (e) {
      if (!e) e = window.event;
      const keyCode = e.keyCode || e.which;
      if (keyCode == '13') {
        e.preventDefault();
        searchUser();
        return false;
      }
    };

    document.getElementById('search-btn').addEventListener('click', () => {
        searchUser();
    });

    function searchUser(){
        const query = document.getElementById('search-input').value;
        if(!query || query.trim() === ''){
            switchList('friend');
            return;
        }

        apiFetch(`${ctx}/friend/searchuser?query=${query}`, {
                method: 'GET',
            })
            .then(data => {
                console.log(data);
                drawSearchList(data);
            })
            .catch(error => {
                console.error('Error:', error);
                showAlert("ì‚¬ìš©ì ê²€ìƒ‰ì— ì‹¤íŒ¨í•˜ì˜€ìŠµë‹ˆë‹¤.", () =>{
                    location.href = './index.html';
                });
                return;
            });

    }

    function drawSearchList(data){
        switchList('search');
        
      const listContainer = document.querySelector(".list");
      const emptyContainer = document.querySelector(".list.empty");
      document.querySelector(".friend-count-num").innerText = data.length;

      if (!data || data.length === 0) {
        emptyContainer.style.display = "flex";
        listContainer.style.display = "none";
        document.getElementById("empty-span-message").innerText = "ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.";
        return;
      } else {
        emptyContainer.style.display = "none";
        listContainer.style.display = "block";
      }

      searchList.innerHTML = '';

      data.forEach(user => {
        let html = `
          <div class="list-item">
            <div class="thumbnail"></div>
            <div class="info">
              <div class="title">${user.user_nm}</div>
            </div>
            <input type="hidden" name="user_id" value="${user.user_id}" />`;
            
        if(user.friend_status){
          html += `<span class="badge badge-friend">${messageObject[user.friend_status].status}</span>`;
        }else{
          html += `<button class="accept-btn" aria-label="ì¹œêµ¬ì‹ ì²­í•˜ê¸°">+</button>`;
        }
        html += `</div>`;
        searchList.insertAdjacentHTML('beforeend', html);
        // const lastItem = listContainer.lastElementChild;
        // lastItem.querySelector(".thumbnail").style.backgroundImage = `url(${friend.image_url})`;
      });

      // ì¶”ê°€ ë²„íŠ¼ í´ë¦­ ì‹œ ì¹œêµ¬ ìš”ì²­
      searchList.querySelectorAll('.accept-btn').forEach(item => {
        item.addEventListener('click', function(e) {
          apiFetch(`${ctx}/friend`, {
                method: 'POST',
                body: JSON.stringify({
                    friend_user_id: item.parentElement.querySelector('input[name="user_id"]').value
                }),
            }).then(data => {
                console.log(data);
                showAlert("ì¹œêµ¬ ì‹ ì²­ì„ ì „ì†¡í•˜ì˜€ìŠµë‹ˆë‹¤!", () =>{
                  hideAlert();
                  callFriendList();
                });
            });
        });
      });

    }

    // ë¦¬ìŠ¤íŠ¸ ì „í™˜ (ì¹œêµ¬ ëª©ë¡ / ê²€ìƒ‰ ëª©ë¡)
    function switchList(flag){
        if(flag === 'friend'){
            friendList.style.display = 'block';
            searchList.style.display = 'none';
            tabContainer.style.display = 'flex';
        } else if (flag === 'search'){
            friendList.style.display = 'none';
            searchList.style.display = 'block';
            tabContainer.style.display = 'none';
        }
    }

  </script>
</body>

</html>