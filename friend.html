<!DOCTYPE html>
<html lang="ko">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Goal Tracker</title>
  <link rel="stylesheet" href="./css/default.css">
  <script type="text/javascript" src="./js/common.js"></script>
</head>

<body>

  <!-- ìƒë‹¨ ë©”ë‰´ -->
  <header>
    <div class="header-left">Goal Tracker</div>
  </header>

  <div class="list-container">
    <!-- ì¹œêµ¬ ì¶”ê°€ [S] -->
    <h3 class="section-title">ì¹œêµ¬ì¶”ê°€</h3>
    <div class="search-bar">
        <input type="text" id="search-input" placeholder="ì¶”ê°€í•  ì¹œêµ¬ì˜ ID ë˜ëŠ” ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”." autocomplete="off"/>
        <button class="clear-btn" id="search-clear-btn" aria-label="ê²€ìƒ‰ ì·¨ì†Œ" type="button" onclick="javascript:switchList('friend')">&times;</button>
        <button id="search-btn" class="search-btn" aria-label="ê²€ìƒ‰" type="button">
            <span class="search-icon">&#128269;</span>
        </button>
    </div>
    <!-- ì¹œêµ¬ ì¶”ê°€ [E] -->
    <hr class="section-divider">
    <h3 class="section-title">ì¹œêµ¬ëª©ë¡</h3>
    <div class="friend-list-header">
      <!-- ì¹œêµ¬ ìˆ˜ í…ìŠ¤íŠ¸ ì¶”ê°€ [S] -->
      <div class="friend-count">
          <span class="friend-count-num">0</span>ëª…
      </div>
      <!-- í† ê¸€ ë²„íŠ¼ -->
      <div>
        <span class="toggle-label" style="margin-right: 8px;">ëŒ€ê¸°ì¤‘ ë³´ê¸°</span>
        <label class="toggle-switch">
          <input type="checkbox" id="filter-toggle">
          <span class="slider"></span>
        </label>
      </div>
    </div>
    <!-- ì¹œêµ¬ ìˆ˜ í…ìŠ¤íŠ¸ ì¶”ê°€ [E] -->
    <!-- ì¹œêµ¬ ëª©ë¡ [S] -->
    <div class="list">
        <div id="friend-list"></div>
        <div id="search-list"></div>
    </div>
    <!-- ì¹œêµ¬ ëª©ë¡ ì—†ì„ ë•Œ -->
    <div class="list empty" style="display:none;">
      <div class="empty-message">
        <span class="empty-icon">ğŸ“„</span>
        <span>ê°œë°œì¤‘ì…ë‹ˆë‹¤. ìœ ì € ê²€ìƒ‰ë§Œ ê°€ëŠ¥í•©ë‹ˆë‹¤.</span>
      </div>
    </div>
    <!-- ì¹œêµ¬ ëª©ë¡ [E] -->
  </div>

  <!-- í•˜ë‹¨ ë„¤ë¹„ê²Œì´ì…˜ -->
  <nav class="bottom-nav">
    <button class="nav-item active" onclick="location.href='./index.html'">
      <span>ğŸ </span>
      <span class="label">í™ˆ</span>
    </button>
    <button class="nav-item" onclick="location.href='./setting.html'">
      <span>âš™ï¸</span>
      <span class="label">ì„¤ì •</span>
    </button>
  </nav>
  
  <div class="alert-modal" id="alert-modal" style="display:none;">
    <div class="alert-content">
        <p id="alert-message">íŒì—… ì˜ˆì‹œ</p>
        <button id="alert-close" onclick="hideAlert()">í™•ì¸</button>
    </div>
  </div>
  <script>
    const friendList = document.getElementById('friend-list');
    const searchList = document.getElementById('search-list');

    // document.ready 
    document.addEventListener('DOMContentLoaded', function () {
      console.log('Document is ready with vanilla JavaScript!');
      callFriendList();
    });

    function callFriendList(){
      const status = document.getElementById('filter-toggle').checked ? 'ALL' : 'PENDING';
      apiFetch(`${ctx}/friend/list?status=${status}`, {
            method: 'GET',
        })
        .then(data => {
          console.log(data);
          drawFriendList(data);
        })
        .catch(error => {
          console.error('Error:', error);
          showAlert("ì¹œêµ¬ ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨í•˜ì˜€ìŠµë‹ˆë‹¤.", () =>{
            location.href = './index.html';
          });
          return;
        });
    }

    // ì¹œêµ¬ ëª©ë¡ ê·¸ë¦¬ê¸°
    function drawFriendList(data){
      switchList('friend');

      const listContainer = document.querySelector(".list");
      const emptyContainer = document.querySelector(".list.empty");
      document.querySelector(".friend-count-num").innerText = data.length;

      // ê¸°ì¡´ ëª©ë¡ ì´ˆê¸°í™”
      friendList.innerHTML = '';

      if (!data || data.length === 0) {
        emptyContainer.style.display = "flex";
        listContainer.style.display = "none";
        return;
      } else {
        emptyContainer.style.display = "none";
        listContainer.style.display = "block";
      }

      data.forEach(friend => {
        const html = `
          <div class="list-item">
            <div class="thumbnail"></div>
            <div class="info">
              <div class="title">${friend.friend_user_nm}</div>
            </div>
            <input type="hidden" name="user_id" value="${friend.friend_user_id}" />
            <button class="close-btn" aria-label="ì‚­ì œ">Ã—</button>
          </div>
        `;
        friendList.insertAdjacentHTML('beforeend', html);
        // const lastItem = listContainer.lastElementChild;
        // lastItem.querySelector(".thumbnail").style.backgroundImage = `url(${friend.image_url})`;
      });

      // ë‹«ê¸° ë²„íŠ¼ í´ë¦­ ì‹œ ì¹œêµ¬ ì‚­ì œ 
      friendList.querySelectorAll('.close-btn').forEach(item => {
        item.addEventListener('click', function(e) {
          showAlert("ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?", () => {
            apiFetch(`${ctx}/friend/delete`, {
                method: 'DELETE',
                body: JSON.stringify({
                    friend_user_id: item.parentElement.querySelector('input[name="user_id"]').value
                }),
            }).then(data => {
                console.log(data);
                hideAlert();
                callFriendList();
            });
          });
        });
      });
    }

    document.getElementById('search-input').onkeypress = function (e) {
      if (!e) e = window.event;
      const keyCode = e.keyCode || e.which;
      if (keyCode == '13') {
        e.preventDefault();
        searchUser();
        return false;
      }
    };

    document.getElementById('search-btn').addEventListener('click', () => {
        searchUser();
    });

    function searchUser(){
        const query = document.getElementById('search-input').value;
        if(!query || query.trim() === ''){
            switchList('friend');
            return;
        }

        apiFetch(`${ctx}/user/list?query=${query}`, {
                method: 'GET',
            })
            .then(data => {
                console.log(data);
                drawSearchList(data);
            })
            .catch(error => {
                console.error('Error:', error);
                showAlert("ì‚¬ìš©ì ê²€ìƒ‰ì— ì‹¤íŒ¨í•˜ì˜€ìŠµë‹ˆë‹¤.", () =>{
                    location.href = './index.html';
                });
                return;
            });

    }

    function drawSearchList(data){
        switchList('search');
        
      const listContainer = document.querySelector(".list");
      const emptyContainer = document.querySelector(".list.empty");
      document.querySelector(".friend-count-num").innerText = data.length;

      if (!data || data.length === 0) {
        emptyContainer.style.display = "flex";
        listContainer.style.display = "none";
        return;
      } else {
        emptyContainer.style.display = "none";
        listContainer.style.display = "block";
      }

      searchList.innerHTML = '';

      data.forEach(user => {
        const html = `
          <div class="list-item">
            <div class="thumbnail"></div>
            <div class="info">
              <div class="title">${user.user_nm}</div>
            </div>
            <input type="hidden" name="user_id" value="${user.user_id}" />
            <button class="accept-btn" aria-label="ì¹œêµ¬ì‹ ì²­í•˜ê¸°">+</button>
          </div>
        `;
        searchList.insertAdjacentHTML('beforeend', html);
        // const lastItem = listContainer.lastElementChild;
        // lastItem.querySelector(".thumbnail").style.backgroundImage = `url(${friend.image_url})`;
      });

      // ì¶”ê°€ ë²„íŠ¼ í´ë¦­ ì‹œ ì¹œêµ¬ ìš”ì²­
      searchList.querySelectorAll('.accept-btn').forEach(item => {
        item.addEventListener('click', function(e) {
          apiFetch(`${ctx}/friend`, {
                method: 'POST',
                body: JSON.stringify({
                    friend_user_id: item.parentElement.querySelector('input[name="user_id"]').value
                }),
            }).then(data => {
                console.log(data);
                hideAlert();
                callFriendList();
            });
        });
      });
    }

    // ë¦¬ìŠ¤íŠ¸ ì „í™˜ (ì¹œêµ¬ ëª©ë¡ / ê²€ìƒ‰ ëª©ë¡)
    function switchList(flag){
        if(flag === 'friend'){
            friendList.style.display = 'block';
            searchList.style.display = 'none';
        } else if (flag === 'search'){
            friendList.style.display = 'none';
            searchList.style.display = 'block';
        }
    }

  </script>
</body>

</html>