<!DOCTYPE html>
<html lang="ko">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Goal Tracker</title>
  <link rel="stylesheet" href="./css/default.css">
  <script type="text/javascript" src="./js/profile/properties.local.js"></script>
</head>

<body>

  <!-- 상단 메뉴 -->
  <header>
    <div class="header-left">Goal Tracker</div>
    <div class="header-right">
      <button id="add-btn" onclick="location.href='./add.html'">➕</button>
      <button id="notice-btn" onclick="location.href='./notice.html'">🔔</button>
    </div>
  </header>

  <div class="list-container">
    <!-- 토글 버튼 -->
    <div class="list-header">
      <label class="toggle-switch">
        <input type="checkbox" id="filter-toggle">
        <span class="slider"></span>
      </label>
      <span class="toggle-label">완료만 보기</span>
    </div>
    <!-- 달성표 목록 -->
    <div class="list">
    </div>
    <!-- 달성표 목록 없을 때 -->
    <div class="list empty" style="display:none;">
      <div class="empty-message">
        <span class="empty-icon">📄</span>
        <span>데이터가 없습니다.</span>
      </div>
    </div>
  </div>

  <!-- 하단 네비게이션 -->
  <nav class="bottom-nav">
    <button class="nav-item active" onclick="()=>{}">
      <span>🏠</span>
      <span class="label">홈</span>
    </button>
    <button class="nav-item" onclick="location.href='./setting.html'">
      <span>⚙️</span>
      <span class="label">설정</span>
    </button>
  </nav>
  
  <div class="alert-modal" id="alert-modal" style="display:none;">
    <div class="alert-content">
        <p id="alert-message">비밀번호가 틀렸습니다.</p>
        <button id="alert-close" onclick="hideAlert()">확인</button>
    </div>
  </div>
  <script>
    // document.ready 
    document.addEventListener('DOMContentLoaded', function () {
      console.log('Document is ready with vanilla JavaScript!');
      callStampList();
    });

    function callStampList(){
      let is_complete = document.getElementById("filter-toggle").checked ? 'Y' : 'N';

      apiFetch(`${ctx}/stamp/list?is_complete=${is_complete}`, {
            method: 'GET',
        })
        .then(data => {
          console.log(data);
          drawStampList(data);
        })
        .catch(error => {
          console.error('Error:', error);
          showAlert("스탬프 목록을 불러오기 실패하였습니다. 다시 로그인해주세요.", () =>{
            location.href = './login.html';
          });
          return;
        });
    }

    // 스탬프 목록 그리기 
    function drawStampList(data){
      const listContainer = document.querySelector(".list");
      const emptyContainer = document.querySelector(".list.empty");

      // 기존 목록 초기화
      listContainer.innerHTML = '';

      if (!data || data.length === 0) {
        emptyContainer.style.display = "flex";
        listContainer.style.display = "none";
        return;
      } else {
        emptyContainer.style.display = "none";
        listContainer.style.display = "block";
      }

      data.forEach(stamp => {
        const percent = Math.floor(stamp.progress_cnt / stamp.total_cnt * 100);
        const html = `
          <div class="list-item">
            <div class="thumbnail"></div>
            <div class="info">
              <div class="title">${stamp.stamp_nm}</div>
              <div class="progress">
                <div class="progress-bar" style="width: ${percent}%;"></div>
                <span class="progress-text">${stamp.progress_cnt}/${stamp.total_cnt}</span>
              </div>
            </div>
            <button class="menu-btn" style="display:none;">⋮</button>
            <div class="dropdown">
              <button>편집</button>
              <button>삭제</button>
              <button>공유</button>
            </div>
          </div>
        `;
        listContainer.insertAdjacentHTML('beforeend', html);
        const lastItem = listContainer.lastElementChild;
        lastItem.querySelector(".thumbnail").style.backgroundImage = `url(${stamp.image_url})`;
      });

      // 각 list-item 클릭 시 상세 페이지 이동 (menu-btn 클릭 시는 제외)
      listContainer.querySelectorAll('.list-item').forEach(item => {
        item.addEventListener('click', function(e) {
          if (e.target.closest('.menu-btn')) return; // 메뉴버튼 클릭 시 무시
          const idx = Array.from(listContainer.children).indexOf(item);
          const stamp = data[idx];
          location.href = `./detail.html?stamp_id=${stamp.stamp_id}`;
        });
      });
      /*
      // 스탬프 목록에 있는 드롭다운 메뉴 토글 
      document.querySelectorAll(".menu-btn").forEach(btn => {
        btn.addEventListener("click", (e) => {
          e.stopPropagation(); // 부모로 이벤트 전파 방지
          const item = e.target.closest(".list-item");
          const dropdown = item.querySelector(".dropdown");

          // 다른 드롭다운 닫기
          document.querySelectorAll(".list-item").forEach(i => {
            if (i !== item) i.classList.remove("show");
          });

          // 현재 토글
          item.classList.toggle("show");

          if (item.classList.contains("show")) {
            // 위치 계산
            const rect = dropdown.getBoundingClientRect();
            if (rect.bottom > window.innerHeight) {
              dropdown.style.top = "auto";
              dropdown.style.bottom = "100%"; // 위로 열림
            } else {
              dropdown.style.top = "100%";
              dropdown.style.bottom = "auto"; // 아래로 열림
            }
          }
        });
      });

      // 바깥 클릭 시 닫기
      document.addEventListener("click", (e) => {
        if (!e.target.closest(".list-item")) {
          document.querySelectorAll(".list-item").forEach(i => i.classList.remove("show"));
        }
      });
      */
    }

    document.getElementById("filter-toggle").onchange = function() {
      callStampList();
    }
  </script>
  <script type="text/javascript" src="./js/common.js"></script>
</body>

</html>