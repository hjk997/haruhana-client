<!DOCTYPE html>
<html lang="ko">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Goal Tracker</title>
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
  <link rel="stylesheet" href="./css/default.css">
  <script type="text/javascript" src="./js/common.js"></script>
</head>

<body>

  <!-- ìƒë‹¨ ë©”ë‰´ -->
  <header>
    <div class="header-left">Goal Tracker</div>
    <div class="header-right">
      <button id="add-btn" onclick="location.href='./add.html'"><span class="material-icons">add</span></button>
      <button id="friend-btn" onclick="location.href='./friend.html'"><span class="material-icons">group</span></button>
      <button id="notice-btn" onclick="location.href='./notice.html'">
        <span class="material-icons">notifications</span>
        <span id="notice-badge" class="badge-notice" style="display:none;"></span>
      </button>
    </div>
  </header>

  <div class="list-container">
    <!-- í† ê¸€ ë²„íŠ¼ -->
    <div class="list-header">
      <label class="toggle-switch">
        <input type="checkbox" id="filter-toggle">
        <span class="slider"></span>
      </label>
      <span class="toggle-label">ì™„ë£Œë§Œ ë³´ê¸°</span>
    </div>
    <!-- ë‹¬ì„±í‘œ ëª©ë¡ -->
    <div class="list">
    </div>
    <!-- ë‹¬ì„±í‘œ ëª©ë¡ ì—†ì„ ë•Œ -->
    <div class="list empty" style="display:none;">
      <div class="empty-message">
        <span class="empty-icon">ğŸ“„</span>
        <span>ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</span>
      </div>
    </div>
  </div>
  
  <!-- body í•˜ë‹¨ì— ì¶”ê°€ -->
  <div id="bottom-sheet" class="bottom-sheet" style="display:none;">
    <div class="sheet-content">
      <button class="sheet-btn" data-action="edit">í¸ì§‘</button>
      <button class="sheet-btn" data-action="delete">ì‚­ì œ</button>
      <button class="sheet-btn sheet-cancel" data-action="cancel">ì·¨ì†Œ</button>
    </div>
  </div>

  <!-- í•˜ë‹¨ ë„¤ë¹„ê²Œì´ì…˜ -->
  <nav class="bottom-nav">
    <button class="nav-item active" onclick="()=>{}">
      <span>ğŸ </span>
      <span class="label">í™ˆ</span>
    </button>
    <button class="nav-item" onclick="location.href='./setting.html'">
      <span>âš™ï¸</span>
      <span class="label">ì„¤ì •</span>
    </button>
  </nav>
  
  <div class="alert-modal" id="alert-modal" style="display:none;">
    <div class="alert-content">
        <p id="alert-message">ë¹„ë°€ë²ˆí˜¸ê°€ í‹€ë ¸ìŠµë‹ˆë‹¤.</p>
        <button id="alert-close" onclick="hideAlert()">í™•ì¸</button>
    </div>
  </div>
  
  <div class="alert-modal" id="confirm-modal" style="display:none;">
    <div class="alert-content">
        <p id="confirm-message">ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?</p>
        <button id="confirm-yes">í™•ì¸</button>
        <button id="confirm-cancel" onclick="hideConfirm()">ì·¨ì†Œ</button>
    </div>
  </div>
  <script>
    // document.ready 
    document.addEventListener('DOMContentLoaded', function () {
      console.log('Document is ready with vanilla JavaScript!');
      callStampList();
    });

    function callStampList(){
      let is_complete = document.getElementById("filter-toggle").checked ? 'Y' : 'N';

      apiFetch(`${ctx}/stamp/list?is_complete=${is_complete}`, {
            method: 'GET',
        })
        .then(data => {
          console.log(data);
          drawStampList(data);
        })
        .catch(error => {
          console.error('Error:', error);
          showAlert("ìŠ¤íƒ¬í”„ ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨í•˜ì˜€ìŠµë‹ˆë‹¤. ë‹¤ì‹œ ë¡œê·¸ì¸í•´ì£¼ì„¸ìš”.", () =>{
            location.href = './login.html';
          });
          return;
        });
    }

    // ìŠ¤íƒ¬í”„ ëª©ë¡ ê·¸ë¦¬ê¸° 
    function drawStampList(data){
      const listContainer = document.querySelector(".list");
      const emptyContainer = document.querySelector(".list.empty");

      // ê¸°ì¡´ ëª©ë¡ ì´ˆê¸°í™”
      listContainer.innerHTML = '';

      if (!data || data.length === 0) {
        emptyContainer.style.display = "flex";
        listContainer.style.display = "none";
        return;
      } else {
        emptyContainer.style.display = "none";
        listContainer.style.display = "block";
      }

      data.forEach(stamp => {
        const percent = Math.floor(stamp.progress_cnt / stamp.total_cnt * 100);
        let stampType;
        if(stamp.stamp_type === 'basic'){
          stampType = 'ì°¨ê·¼ì°¨ê·¼ ê¾¸ì¤€íˆ';
        } else if(stamp.stamp_type === 'routine'){
          stampType = 'ë§¤ì¼ë§¤ì¼ í•˜ë‚˜ì”©';
        } else {
          stampType = '???';
        }
        const html = `
          <div class="list-item">
            <div class="thumbnail"></div>
            <div class="info">
              <div class="title">${stamp.stamp_nm}</div>
              <div class="progress">
                <div class="progress-bar" style="width: ${percent}%;"></div>
                <span class="progress-text">${stamp.progress_cnt}/${stamp.total_cnt}</span>
              </div>
              <div class="tag-list">
                <span class="tag">${stampType}</span>
              </div>
            </div>
            <button class="menu-btn">â‹®</button>
          </div>
        `;
        listContainer.insertAdjacentHTML('beforeend', html);
        const lastItem = listContainer.lastElementChild;
        lastItem.querySelector(".thumbnail").style.backgroundImage = `url(${stamp.image_url})`;
      });

      // ê° list-item í´ë¦­ ì‹œ ìƒì„¸ í˜ì´ì§€ ì´ë™ (menu-btn í´ë¦­ ì‹œëŠ” ì œì™¸)
      listContainer.querySelectorAll('.list-item').forEach(item => {
        item.addEventListener('click', function(e) {
          if (e.target.closest('.menu-btn')) return; // ë©”ë‰´ë²„íŠ¼ í´ë¦­ ì‹œ ë¬´ì‹œ
          const idx = Array.from(listContainer.children).indexOf(item);
          const stamp = data[idx];
          location.href = `./detail.html?stamp_id=${stamp.stamp_id}`;
        });
      });

      // ìŠ¤íƒ¬í”„ ëª©ë¡ì— ìˆëŠ” ë°”í…€ì‹œíŠ¸ ë©”ë‰´ í† ê¸€
      document.querySelectorAll(".menu-btn").forEach(btn => {
        btn.addEventListener("click", (e) => {
          e.stopPropagation();
          const item = e.target.closest(".list-item");
          item.classList.add("active-menu");
          document.getElementById("bottom-sheet").style.display = "flex";
          // ì„ íƒëœ ì•„ì´í…œì„ ê¸°ì–µ(ì˜ˆ: data-index ë“±)
          document.getElementById("bottom-sheet").dataset.index = Array.from(item.parentNode.children).indexOf(item);
        });
      });

      // ë°”í…€ì‹œíŠ¸ ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸
      document.querySelectorAll('.sheet-btn').forEach(btn => {
        btn.onclick = function() {
          const action = this.dataset.action;
          const sheet = document.getElementById("bottom-sheet");
          const idx = sheet.dataset.index;
          sheet.style.display = "none";
          document.querySelectorAll('.list-item').forEach(i => i.classList.remove('active-menu'));
          if(action === 'cancel') {
            return;
          } else if(action === 'edit'){
            const stamp = data[idx];
            location.href = `./add.html?stamp_id=${stamp.stamp_id}`;
          } else if(action === 'delete'){
            const stamp = data[idx];
            confirm("ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?", () =>{
              hideConfirm();
              apiFetch(`${ctx}/stamp`, {
                method: 'DELETE',
                body: JSON.stringify({
                  stamp_id: stamp.stamp_id
                })
              })
              .then(res => {
                if(res.code === 200){
                  showAlert("ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.", () => {
                    callStampList();
                    hideAlert();
                  });
                }else{
                  showAlert("ì‚­ì œì— ì‹¤íŒ¨í•˜ì˜€ìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.");
                }
              })
              .catch(error => {
                console.error('Error:', error);
                showAlert("ì‚­ì œì— ì‹¤íŒ¨í•˜ì˜€ìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.");
                return;
              });
            });
          }
        }
      });

      // ë°”ê¹¥ í´ë¦­ ì‹œ ë°”í…€ì‹œíŠ¸ ë‹«ê¸°
      document.getElementById("bottom-sheet").addEventListener("click", function(e){
        if(e.target === this){
          this.style.display = "none";
          document.querySelectorAll('.list-item').forEach(i => i.classList.remove('active-menu'));
        }
      });
      
    }

    document.getElementById("filter-toggle").onchange = function() {
      callStampList();
    }
  </script>
</body>

</html>