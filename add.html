<!DOCTYPE html>
<html lang="ko">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Goal Tracker</title>
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/cropperjs@1.6.2/dist/cropper.min.css" rel="stylesheet">
  <link rel="stylesheet" href="./css/default.css">
  <link rel="stylesheet" href="./css/stamp.css">
  <script type="text/javascript" src="./js/common.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/cropperjs@1.6.2/dist/cropper.min.js"></script>
</head>

<body>

  <!-- ìƒë‹¨ ë©”ë‰´ -->
  <header>
    <div class="header-left">Goal stamp</div>
  </header>
  <div class="add-stamp-page page">
    <h2>ìƒˆ ë‹¬ì„±í‘œ ì¶”ê°€</h2>

    <div class="form-item">
      <label for="stamp-name">ë‹¬ì„±í‘œëª…</label>
      <input type="text" id="stamp-name" name="stamp_nm" placeholder="ì˜ˆ: 7ì¼ ë‹¬ì„±í‘œ">
    </div>

    <div class="form-item">
      <label for="stamp-count">ê°œìˆ˜</label>
      <select id="stamp-count">
        <option value="7">7ê°œ</option>
        <option value="30">30ê°œ</option>
        <option value="50">50ê°œ</option>
        <option value="100">100ê°œ</option>
        <option value="custom">ì§ì ‘ ì…ë ¥</option>
      </select>
      <input type="number" id="stamp-count-custom" placeholder="ì§ì ‘ ì…ë ¥(1~100)" style="display:none; margin-top:8px;"
        min="1" max="100">
    </div>

    <div class="form-item">
      <label for="stamp-type">ë‹¬ì„±í‘œ ìœ í˜•</label>
      <select id="stamp-type" name="stamp_type">
        <option value="basic">ë‹¬ì„±í˜•(ë‚ ì§œì— ê´€ê³„ì—†ì´ ëª©í‘œë¥¼ ì™„ìˆ˜)</option>
        <option value="routine">ê·œì¹™í˜•(ë§¤ì¼ í•˜ë£¨ í•˜ë‚˜ì”©)</option>
      </select>
    </div>

    <div class="form-item">
      <label for="stamp-desc">ì„¤ëª…</label>
      <textarea id="stamp-desc" name="stamp_desc" rows="2" class="desc-textarea" maxlength="200" placeholder="ìŠ¤íƒ¬í”„ ì„¤ëª…(~200ì)"></textarea>
    </div>

    <div class="form-item">
      ì´ë¯¸ì§€ ë“±ë¡ (ë‹¬ì„± ì „)
      <!-- ì´ë¯¸ì§€ ë“±ë¡ ë²„íŠ¼ -->
      <div id="open-before-image-modal" class="thumbnail" >ì´ë¯¸ì§€ ì„ íƒ</div>
      <input type="hidden" id="before-image-id" name="before_image_id" value="">
    </div>

    <div class="form-item">
      ì´ë¯¸ì§€ ë“±ë¡ (ë‹¬ì„± í›„)
      <div id="open-after-image-modal" class="thumbnail" >ì´ë¯¸ì§€ ì„ íƒ</div>
      <input type="hidden" id="after-image-id" name="after_image_id" value="">
    </div>

    <button id="add-stamp-btn">ì¶”ê°€</button>
  </div>

  <!-- ì´ë¯¸ì§€ ëª¨ë‹¬ -->
  <div id="image-modal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3>ì´ë¯¸ì§€ ì„ íƒ</h3>
        <div class="modal-actions">
          <button id="modal-close-btn" class="close-btn" title="ë‹«ê¸°"><span class="material-icons">close</span></button>
        </div>
      </div>
      <div class="image-grid" style="display:none;">
      </div>
      <div class="cropper-grid" style="display:none;">
      </div>
      <div class="image-grid-loading">
        <div class="spinner"></div>
      </div>
      <div class="modal-footer">
        <div style="font-size:12px; color:#666; text-align:center; margin:12px auto;">ì´ë¯¸ì§€ëŠ” 1MB ì´í•˜ë¡œ ë“±ë¡í•´ì£¼ì„¸ìš”.</div>
        <div class="modal-actions">
          <button id="modal-add-btn" class="modal-action-btn" title="ì—…ë¡œë“œ">ìƒˆ ì´ë¯¸ì§€ ì—…ë¡œë“œ</button>
          <button id="modal-delete-btn" class="modal-action-btn" title="ì‚­ì œ">ì‚­ì œ</button>
          <button id="modal-cancel-btn" class="modal-action-btn" title="ì·¨ì†Œ">ì·¨ì†Œ</button>
          <button id="modal-select-btn" class="modal-action-btn" title="ì„ íƒ ì™„ë£Œ">ì„ íƒ ì™„ë£Œ</button>
        </div>
      </div>
    </div>
  </div>

  <!-- í•˜ë‹¨ ë„¤ë¹„ê²Œì´ì…˜ -->
  <nav class="bottom-nav">
    <button class="nav-item active" onclick="location.href='./index.html'">
      <span>ğŸ </span>
      <span class="label">í™ˆ</span>
    </button>
    <button class="nav-item" onclick="location.href='./setting.html'">
      <span>âš™ï¸</span>
      <span class="label">ì„¤ì •</span>
    </button>
  </nav>

  <div class="alert-modal" id="alert-modal" style="display:none;">
    <div class="alert-content">
        <p id="alert-message">íŒì—… ì˜ˆì‹œ.</p>
        <button id="alert-close">í™•ì¸</button>
    </div>
  </div>
  <script>
    let cropper;
    const modal = document.getElementById("image-modal");
    const openBeforeBtn = document.getElementById("open-before-image-modal");
    const openAfterBtn = document.getElementById("open-after-image-modal");
    const closeBtn = document.getElementById("modal-close-btn");

    openBeforeBtn.addEventListener("click", () => {
      modal.style.display = "flex";
      reloadImageGrid('before'); // ëª¨ë‹¬ ê·¸ë¦¬ê¸° 
    });

    openAfterBtn.addEventListener("click", () => {
      modal.style.display = "flex";
      reloadImageGrid('after'); // ëª¨ë‹¬ ê·¸ë¦¬ê¸° 
    });

    function selectFile(obj, imageType, imageId){
      if (imageType === 'before') {
        document.getElementById("before-image-id").value = imageId;
        const thumbnail = openBeforeBtn;
        thumbnail.style.backgroundImage = `url('${obj.src}')`;
        thumbnail.textContent = ''; // ê¸°ë³¸ í…ìŠ¤íŠ¸ ì œê±°
      } else if (imageType === 'after') {
        document.getElementById("after-image-id").value = imageId;
        const thumbnail = openAfterBtn;
        thumbnail.style.backgroundImage = `url('${obj.src}')`;
        thumbnail.textContent = ''; // ê¸°ë³¸ í…ìŠ¤íŠ¸ ì œê±°
      }
      modal.style.display = "none";
    }

    // ì´ë¯¸ì§€ ì¶”ê°€ ë²„íŠ¼ í´ë¦­ ì‹œ 
    function uploadFile(imageType){ 
      const fileInput = document.createElement("input");
      fileInput.type = "file";
      fileInput.accept = "image/*";
      fileInput.style.display = "none";
      document.body.appendChild(fileInput);

      fileInput.addEventListener("change", (e) => onChangeFile(e, imageType));

      fileInput.click();
    }

    // ì´ë¯¸ì§€ í¸ì§‘ì°½ í‘œì‹œ 
    function onChangeFile(e, imageType){
      const file = e.target.files[0];
      if (!file) return;

      const imageGrid = document.querySelector(".image-grid");
      const cropperGrid = document.querySelector(".cropper-grid");
      imageGrid.style.display = "none";
      cropperGrid.style.display = "block";

      cropperGrid.innerHTML = ''; // ê¸°ì¡´ ë‚´ìš© ì´ˆê¸°í™”
      cropperGrid.style.display = "grid";

      document.getElementById('modal-add-btn').style.display = "none";
      document.getElementById('modal-delete-btn').style.display = "none";
      document.getElementById('modal-cancel-btn').style.display = "inline-block";
      document.getElementById('modal-select-btn').style.display = "inline-block";

      // ì´ë¯¸ì§€ ê°ì²´ ì¶”ê°€ 
      const image = document.createElement("img");
      cropperGrid.appendChild(image);

      const reader = new FileReader();
      reader.onload = (e) => {
        image.src = e.target.result;

        // ê¸°ì¡´ cropper ìˆìœ¼ë©´ ì œê±°
        if (cropper) cropper.destroy();

        // Cropper.js ì ìš©
        cropper = new Cropper(image, {
          aspectRatio: 1, // ì •ì‚¬ê°í˜• ìë¥´ê¸°
          viewMode: 1
        });
      };
      reader.readAsDataURL(file);

      // ì·¨ì†Œ ë²„íŠ¼ í´ë¦­ ì‹œ 
      document.getElementById('modal-cancel-btn').onclick = () => {
        cropperGrid.style.display = "none";
        imageGrid.style.display = "grid";

        document.getElementById('modal-add-btn').style.display = "block";
        document.getElementById('modal-delete-btn').style.display = "none";
        document.getElementById('modal-cancel-btn').style.display = "none";
        document.getElementById('modal-select-btn').style.display = "none";
      };

      // ì„ íƒ ë²„íŠ¼ í´ë¦­ ì‹œ 
      document.getElementById('modal-select-btn').onclick = () => {
        if(!cropper){
          showAlert('ì´ë¯¸ì§€ê°€ ë¡œë“œë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
          return;
        }
        // Cropper.jsì—ì„œ ì´ë¯¸ì§€ ìë¥´ê¸°
        cropper.getCroppedCanvas().toBlob((blob) => {
          if (blob) {
            const newFile = new File([blob], file.name, { type: file.type });
            uploadImageToS3(newFile, imageType);
          }
        });
      };
    }

    // ì„ íƒí•œ ì´ë¯¸ì§€ s3ì— ë°”ë¡œ ì—…ë¡œë“œ 
    function uploadImageToS3(file, imageType){
        const formData = new FormData();
        formData.append("file", file);
        formData.append("is_public", false);
        formData.append("image_type", imageType);
        
        document.querySelector(".cropper-grid").innerHTML = "";
        document.querySelector(".cropper-grid").style.display = "none";
        document.querySelector(".image-grid-loading").style.display = "grid";
        document.querySelector(".image-grid").style.display = "none";

        formFetch(`${ctx}/stamp-image`, 
        {method: 'PUT', 
          body: formData
        }).then((res) => {
          // ì—…ë¡œë“œ ì„±ê³µ í›„ ì²˜ë¦¬
          if (res.code === 200) {
            showAlert('ì´ë¯¸ì§€ê°€ ì„±ê³µì ìœ¼ë¡œ ì—…ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤.');
            reloadImageGrid(imageType);
          } else {
            showAlert('ì´ë¯¸ì§€ ì—…ë¡œë“œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
          }
        });
    }

    // ëª¨ë‹¬ì— ì´ë¯¸ì§€ í‘œì‹œ
    function reloadImageGrid(imageType){
      document.getElementById('modal-add-btn').style.display = "inline-block";
      document.getElementById('modal-delete-btn').style.display = "none";
      document.getElementById('modal-cancel-btn').style.display = "none";
      document.getElementById('modal-select-btn').style.display = "none";

      const imageGrid = document.querySelector(".image-grid");
      imageGrid.style.display = "grid";
      imageGrid.innerHTML = ""; // ê¸°ì¡´ ë‚´ìš© ì´ˆê¸°í™”
      apiFetch(`${ctx}/stamp-image?image_type=${imageType}`, 'GET')
        .then(data => {
          document.querySelector(".image-grid-loading").style.display = "none";
          document.getElementById("modal-add-btn").onclick = () => uploadFile(imageType);
          data.forEach(img => {
            const imgItem = document.createElement("div");
            imgItem.classList.add("image-item");
            imgItem.innerHTML = `<img src="${img.image_key}" data-image-public='${img.is_public}' data-image-type="${imageType}" data-image-id="${img.image_id}" alt="">`;
            imageGrid.appendChild(imgItem);
          });

          imageGrid.querySelectorAll('.image-item img').forEach(img => {
            img.addEventListener('click', () => {
              if(img.parentElement.classList.contains('selected')){
                img.parentElement.classList.remove('selected');
                document.getElementById('modal-select-btn').style.display = "none";
                document.getElementById('modal-delete-btn').style.display = "none";
                document.getElementById('modal-add-btn').style.display = "block";
                return;
              }

              // ì„ íƒëœ ì´ë¯¸ì§€ ê°•ì¡° í‘œì‹œ
              imageGrid.querySelectorAll('.image-item').forEach(item => {
                item.classList.remove('selected');
              });
              img.parentElement.classList.toggle('selected');

              // ì„ íƒ ë° ì‚­ì œ ë²„íŠ¼ í‘œì‹œ
              document.getElementById('modal-add-btn').style.display = "none";

              if(img.dataset.imagePublic === 'false'){
                document.getElementById('modal-delete-btn').style.display = "inline-block";
              }
              document.getElementById('modal-select-btn').style.display = "inline-block";

              // ì„ íƒ ë²„íŠ¼ í´ë¦­ ì‹œ
              document.getElementById('modal-select-btn').onclick = () => {
                selectFile(img, imageType, img.dataset.imageId);
              };

              // ì‚­ì œ ë²„íŠ¼ í´ë¦­ ì‹œ
              document.getElementById('modal-delete-btn').onclick = () => {
                if (confirm('ì •ë§ë¡œ ì´ ì´ë¯¸ì§€ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                  apiFetch(`${ctx}/stamp-image/`, {
                    method: 'DELETE',
                    body: JSON.stringify({
                      image_id: img.dataset.imageId
                    })
                  }).then(data => {
                    if (data && data.code === 200) {
                      showAlert('ì´ë¯¸ì§€ê°€ ì„±ê³µì ìœ¼ë¡œ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
                      reloadImageGrid(imageType);
                    } else {
                      showAlert('ì´ë¯¸ì§€ ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
                    }
                  });
                }
              };
            });
          });
        })
        .catch(error => {
          console.error('Error:', error);
          showAlert('ì„œë²„ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ë‚˜ì¤‘ì— ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
        });
    }

    closeBtn.addEventListener("click", () => {
      modal.style.display = "none";
    });

    // ëª¨ë‹¬ ë°”ê¹¥ í´ë¦­ ì‹œ ë‹«ê¸°
    window.addEventListener("click", (e) => {
      if (e.target === modal) modal.style.display = "none";
    });

    // selectì—ì„œ 'ì§ì ‘ ì…ë ¥' ì„ íƒ ì‹œ input í‘œì‹œ
    const stampCountSelect = document.getElementById('stamp-count');
    const stampCountCustom = document.getElementById('stamp-count-custom');
    stampCountSelect.addEventListener('change', function () {
      if (this.value === 'custom') {
        stampCountCustom.style.display = 'block';
      } else {
        stampCountCustom.style.display = 'none';
      }
    });

    // ì¶”ê°€ ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸ 
    document.querySelector('#add-stamp-btn').addEventListener('click', () => {
      const stampName = document.getElementById('stamp-name').value;
      const stampCount = stampCountSelect.value === 'custom' ? stampCountCustom.value : stampCountSelect.value;
      const stampType = document.getElementById('stamp-type').value;
      const stampDesc = document.getElementById('stamp-desc').value;
      const beforeImageId = document.getElementById('before-image-id').value;
      const afterImageId = document.getElementById('after-image-id').value;

      // ì…ë ¥ê°’ ê²€ì¦
      if (!stampName) {
        alert('ë‹¬ì„±í‘œëª…ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
        return;
      }
      if (!stampCount || isNaN(stampCount) || stampCount < 1 || stampCount > 100) {
        alert('ìœ íš¨í•œ ê°œìˆ˜ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš” (1~100).');
        return;
      }

      if(beforeImageId === undefined || beforeImageId === '') {
        showAlert("ë‹¬ì„± ì „ ì´ë¯¸ì§€ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.");
        return;
      }

      if(afterImageId === undefined || afterImageId === '') {
        showAlert("ë‹¬ì„± í›„ ì´ë¯¸ì§€ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.");
        return;
      }

      // JSON ë°ì´í„° ìƒì„±
      const reqData = {
        stamp_nm: stampName,
        total_cnt: stampCount,
        stamp_type: stampType,
        stamp_desc: stampDesc,
        before_image_id: beforeImageId,
        after_image_id: afterImageId
      };

      // ì„œë²„ë¡œ ì „ì†¡ 
      apiFetch(`${ctx}/stamp`, {
        method: 'POST',
        body: JSON.stringify(reqData)
      })
        .then(data => {
          if (data.code === 200) {
            showAlert('ë‹¬ì„±í‘œê°€ ì„±ê³µì ìœ¼ë¡œ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤!', ()=>{
              window.location.href = './index.html'; // í™ˆìœ¼ë¡œ ì´ë™
            });
            
          } else {
            showAlert('ë‹¬ì„±í‘œ ì¶”ê°€ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
          }
        })
        .catch(error => {
          console.error('Error:', error);
          showAlert('ì„œë²„ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ë‚˜ì¤‘ì— ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
        });
    });
  </script>

</body>

</html>