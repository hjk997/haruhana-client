<!DOCTYPE html>
<html lang="ko">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Goal Tracker</title>
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/cropperjs@1.6.2/dist/cropper.min.css" rel="stylesheet">
  <link rel="stylesheet" href="./css/default.css">
  <link rel="stylesheet" href="./css/stamp.css">
  <script type="text/javascript" src="./js/common.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/cropperjs@1.6.2/dist/cropper.min.js"></script>
</head>

<body>

  <!-- 상단 메뉴 -->
  <header>
    <div class="header-left">Goal stamp</div>
  </header>
  <div class="add-stamp-page page">
    <h2>새 달성표 추가</h2>

    <div class="form-item">
      <label for="stamp-name">달성표명</label>
      <input type="text" id="stamp-name" name="stamp_nm" placeholder="예: 7일 달성표">
    </div>

    <div class="form-item">
      <label for="stamp-count">개수</label>
      <select id="stamp-count">
        <option value="7">7개</option>
        <option value="30">30개</option>
        <option value="50">50개</option>
        <option value="100">100개</option>
        <option value="custom">직접 입력</option>
      </select>
      <input type="number" id="stamp-count-custom" placeholder="직접 입력(1~100)" style="display:none; margin-top:8px;"
        min="1" max="100">
    </div>

    <div class="form-item">
      <label for="stamp-type">달성표 유형</label>
      <select id="stamp-type" name="stamp_type">
        <option value="basic">달성형(날짜에 관계없이 목표를 완수)</option>
        <option value="routine">규칙형(매일 하루 하나씩)</option>
      </select>
    </div>

    <div class="form-item">
      <label for="stamp-desc">설명</label>
      <textarea id="stamp-desc" name="stamp_desc" rows="2" class="desc-textarea" maxlength="200" placeholder="스탬프 설명(~200자)"></textarea>
    </div>

    <div class="form-item">
      이미지 등록 (달성 전)
      <!-- 이미지 등록 버튼 -->
      <div id="open-before-image-modal" class="thumbnail" >이미지 선택</div>
      <input type="hidden" id="before-image-id" name="before_image_id" value="">
    </div>

    <div class="form-item">
      이미지 등록 (달성 후)
      <div id="open-after-image-modal" class="thumbnail" >이미지 선택</div>
      <input type="hidden" id="after-image-id" name="after_image_id" value="">
    </div>

    <button id="add-stamp-btn">추가</button>
  </div>

  <!-- 이미지 모달 -->
  <div id="image-modal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3>이미지 선택</h3>
        <div class="modal-actions">
          <button id="modal-close-btn" class="close-btn" title="닫기"><span class="material-icons">close</span></button>
        </div>
      </div>
      <div class="image-grid" style="display:none;">
      </div>
      <div class="cropper-grid" style="display:none;">
      </div>
      <div class="image-grid-loading">
        <div class="spinner"></div>
      </div>
      <div class="modal-footer">
        <div style="font-size:12px; color:#666; text-align:center; margin:12px auto;">이미지는 1MB 이하로 등록해주세요.</div>
        <div class="modal-actions">
          <button id="modal-add-btn" class="modal-action-btn" title="업로드">새 이미지 업로드</button>
          <button id="modal-delete-btn" class="modal-action-btn" title="삭제">삭제</button>
          <button id="modal-cancel-btn" class="modal-action-btn" title="취소">취소</button>
          <button id="modal-select-btn" class="modal-action-btn" title="선택 완료">선택 완료</button>
        </div>
      </div>
    </div>
  </div>

  <!-- 하단 네비게이션 -->
  <nav class="bottom-nav">
    <button class="nav-item active" onclick="location.href='./index.html'">
      <span>🏠</span>
      <span class="label">홈</span>
    </button>
    <button class="nav-item" onclick="location.href='./setting.html'">
      <span>⚙️</span>
      <span class="label">설정</span>
    </button>
  </nav>

  <div class="alert-modal" id="alert-modal" style="display:none;">
    <div class="alert-content">
        <p id="alert-message">팝업 예시.</p>
        <button id="alert-close">확인</button>
    </div>
  </div>
  <script>
    let cropper;
    const modal = document.getElementById("image-modal");
    const openBeforeBtn = document.getElementById("open-before-image-modal");
    const openAfterBtn = document.getElementById("open-after-image-modal");
    const closeBtn = document.getElementById("modal-close-btn");

    openBeforeBtn.addEventListener("click", () => {
      modal.style.display = "flex";
      reloadImageGrid('before'); // 모달 그리기 
    });

    openAfterBtn.addEventListener("click", () => {
      modal.style.display = "flex";
      reloadImageGrid('after'); // 모달 그리기 
    });

    function selectFile(obj, imageType, imageId){
      if (imageType === 'before') {
        document.getElementById("before-image-id").value = imageId;
        const thumbnail = openBeforeBtn;
        thumbnail.style.backgroundImage = `url('${obj.src}')`;
        thumbnail.textContent = ''; // 기본 텍스트 제거
      } else if (imageType === 'after') {
        document.getElementById("after-image-id").value = imageId;
        const thumbnail = openAfterBtn;
        thumbnail.style.backgroundImage = `url('${obj.src}')`;
        thumbnail.textContent = ''; // 기본 텍스트 제거
      }
      modal.style.display = "none";
    }

    // 이미지 추가 버튼 클릭 시 
    function uploadFile(imageType){ 
      const fileInput = document.createElement("input");
      fileInput.type = "file";
      fileInput.accept = "image/*";
      fileInput.style.display = "none";
      document.body.appendChild(fileInput);

      fileInput.addEventListener("change", (e) => onChangeFile(e, imageType));

      fileInput.click();
    }

    // 이미지 편집창 표시 
    function onChangeFile(e, imageType){
      const file = e.target.files[0];
      if (!file) return;

      const imageGrid = document.querySelector(".image-grid");
      const cropperGrid = document.querySelector(".cropper-grid");
      imageGrid.style.display = "none";
      cropperGrid.style.display = "block";

      cropperGrid.innerHTML = ''; // 기존 내용 초기화
      cropperGrid.style.display = "grid";

      document.getElementById('modal-add-btn').style.display = "none";
      document.getElementById('modal-delete-btn').style.display = "none";
      document.getElementById('modal-cancel-btn').style.display = "inline-block";
      document.getElementById('modal-select-btn').style.display = "inline-block";

      // 이미지 객체 추가 
      const image = document.createElement("img");
      cropperGrid.appendChild(image);

      const reader = new FileReader();
      reader.onload = (e) => {
        image.src = e.target.result;

        // 기존 cropper 있으면 제거
        if (cropper) cropper.destroy();

        // Cropper.js 적용
        cropper = new Cropper(image, {
          aspectRatio: 1, // 정사각형 자르기
          viewMode: 1
        });
      };
      reader.readAsDataURL(file);

      // 취소 버튼 클릭 시 
      document.getElementById('modal-cancel-btn').onclick = () => {
        cropperGrid.style.display = "none";
        imageGrid.style.display = "grid";

        document.getElementById('modal-add-btn').style.display = "block";
        document.getElementById('modal-delete-btn').style.display = "none";
        document.getElementById('modal-cancel-btn').style.display = "none";
        document.getElementById('modal-select-btn').style.display = "none";
      };

      // 선택 버튼 클릭 시 
      document.getElementById('modal-select-btn').onclick = () => {
        if(!cropper){
          showAlert('이미지가 로드되지 않았습니다. 다시 시도해주세요.');
          return;
        }
        // Cropper.js에서 이미지 자르기
        cropper.getCroppedCanvas().toBlob((blob) => {
          if (blob) {
            const newFile = new File([blob], file.name, { type: file.type });
            uploadImageToS3(newFile, imageType);
          }
        });
      };
    }

    // 선택한 이미지 s3에 바로 업로드 
    function uploadImageToS3(file, imageType){
        const formData = new FormData();
        formData.append("file", file);
        formData.append("is_public", false);
        formData.append("image_type", imageType);
        
        document.querySelector(".cropper-grid").innerHTML = "";
        document.querySelector(".cropper-grid").style.display = "none";
        document.querySelector(".image-grid-loading").style.display = "grid";
        document.querySelector(".image-grid").style.display = "none";

        formFetch(`${ctx}/stamp-image`, 
        {method: 'PUT', 
          body: formData
        }).then((res) => {
          // 업로드 성공 후 처리
          if (res.code === 200) {
            showAlert('이미지가 성공적으로 업로드되었습니다.');
            reloadImageGrid(imageType);
          } else {
            showAlert('이미지 업로드에 실패했습니다. 다시 시도해주세요.');
          }
        });
    }

    // 모달에 이미지 표시
    function reloadImageGrid(imageType){
      document.getElementById('modal-add-btn').style.display = "inline-block";
      document.getElementById('modal-delete-btn').style.display = "none";
      document.getElementById('modal-cancel-btn').style.display = "none";
      document.getElementById('modal-select-btn').style.display = "none";

      const imageGrid = document.querySelector(".image-grid");
      imageGrid.style.display = "grid";
      imageGrid.innerHTML = ""; // 기존 내용 초기화
      apiFetch(`${ctx}/stamp-image?image_type=${imageType}`, 'GET')
        .then(data => {
          document.querySelector(".image-grid-loading").style.display = "none";
          document.getElementById("modal-add-btn").onclick = () => uploadFile(imageType);
          data.forEach(img => {
            const imgItem = document.createElement("div");
            imgItem.classList.add("image-item");
            imgItem.innerHTML = `<img src="${img.image_key}" data-image-public='${img.is_public}' data-image-type="${imageType}" data-image-id="${img.image_id}" alt="">`;
            imageGrid.appendChild(imgItem);
          });

          imageGrid.querySelectorAll('.image-item img').forEach(img => {
            img.addEventListener('click', () => {
              if(img.parentElement.classList.contains('selected')){
                img.parentElement.classList.remove('selected');
                document.getElementById('modal-select-btn').style.display = "none";
                document.getElementById('modal-delete-btn').style.display = "none";
                document.getElementById('modal-add-btn').style.display = "block";
                return;
              }

              // 선택된 이미지 강조 표시
              imageGrid.querySelectorAll('.image-item').forEach(item => {
                item.classList.remove('selected');
              });
              img.parentElement.classList.toggle('selected');

              // 선택 및 삭제 버튼 표시
              document.getElementById('modal-add-btn').style.display = "none";

              if(img.dataset.imagePublic === 'false'){
                document.getElementById('modal-delete-btn').style.display = "inline-block";
              }
              document.getElementById('modal-select-btn').style.display = "inline-block";

              // 선택 버튼 클릭 시
              document.getElementById('modal-select-btn').onclick = () => {
                selectFile(img, imageType, img.dataset.imageId);
              };

              // 삭제 버튼 클릭 시
              document.getElementById('modal-delete-btn').onclick = () => {
                if (confirm('정말로 이 이미지를 삭제하시겠습니까?')) {
                  apiFetch(`${ctx}/stamp-image/`, {
                    method: 'DELETE',
                    body: JSON.stringify({
                      image_id: img.dataset.imageId
                    })
                  }).then(data => {
                    if (data && data.code === 200) {
                      showAlert('이미지가 성공적으로 삭제되었습니다.');
                      reloadImageGrid(imageType);
                    } else {
                      showAlert('이미지 삭제에 실패했습니다. 다시 시도해주세요.');
                    }
                  });
                }
              };
            });
          });
        })
        .catch(error => {
          console.error('Error:', error);
          showAlert('서버 오류가 발생했습니다. 나중에 다시 시도해주세요.');
        });
    }

    closeBtn.addEventListener("click", () => {
      modal.style.display = "none";
    });

    // 모달 바깥 클릭 시 닫기
    window.addEventListener("click", (e) => {
      if (e.target === modal) modal.style.display = "none";
    });

    // select에서 '직접 입력' 선택 시 input 표시
    const stampCountSelect = document.getElementById('stamp-count');
    const stampCountCustom = document.getElementById('stamp-count-custom');
    stampCountSelect.addEventListener('change', function () {
      if (this.value === 'custom') {
        stampCountCustom.style.display = 'block';
      } else {
        stampCountCustom.style.display = 'none';
      }
    });

    // 추가 버튼 클릭 이벤트 
    document.querySelector('#add-stamp-btn').addEventListener('click', () => {
      const stampName = document.getElementById('stamp-name').value;
      const stampCount = stampCountSelect.value === 'custom' ? stampCountCustom.value : stampCountSelect.value;
      const stampType = document.getElementById('stamp-type').value;
      const stampDesc = document.getElementById('stamp-desc').value;
      const beforeImageId = document.getElementById('before-image-id').value;
      const afterImageId = document.getElementById('after-image-id').value;

      // 입력값 검증
      if (!stampName) {
        alert('달성표명을 입력해주세요.');
        return;
      }
      if (!stampCount || isNaN(stampCount) || stampCount < 1 || stampCount > 100) {
        alert('유효한 개수를 입력해주세요 (1~100).');
        return;
      }

      if(beforeImageId === undefined || beforeImageId === '') {
        showAlert("달성 전 이미지를 선택해주세요.");
        return;
      }

      if(afterImageId === undefined || afterImageId === '') {
        showAlert("달성 후 이미지를 선택해주세요.");
        return;
      }

      // JSON 데이터 생성
      const reqData = {
        stamp_nm: stampName,
        total_cnt: stampCount,
        stamp_type: stampType,
        stamp_desc: stampDesc,
        before_image_id: beforeImageId,
        after_image_id: afterImageId
      };

      // 서버로 전송 
      apiFetch(`${ctx}/stamp`, {
        method: 'POST',
        body: JSON.stringify(reqData)
      })
        .then(data => {
          if (data.code === 200) {
            showAlert('달성표가 성공적으로 추가되었습니다!', ()=>{
              window.location.href = './index.html'; // 홈으로 이동
            });
            
          } else {
            showAlert('달성표 추가에 실패했습니다. 다시 시도해주세요.');
          }
        })
        .catch(error => {
          console.error('Error:', error);
          showAlert('서버 오류가 발생했습니다. 나중에 다시 시도해주세요.');
        });
    });
  </script>

</body>

</html>