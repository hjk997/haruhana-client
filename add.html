<!DOCTYPE html>
<html lang="ko">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Goal Tracker</title>
  <link rel="stylesheet" href="./css/default.css">
  <script type="text/javascript" src="./js/common.js"></script>
  <script type="text/javascript" src="./js/profile/properties.local.js"></script>
  <style>
    .add-stamp-page {
      padding: 16px;
      margin-bottom: 60px;
      /* í•˜ë‹¨ ë„¤ë¹„ê²Œì´ì…˜ ê³µê°„ í™•ë³´ */
    }

    .add-stamp-page h2 {
      font-size: 1.5rem;
      margin-bottom: 16px;
    }

    .form-item {
      display: flex;
      flex-direction: column;
      margin-bottom: 16px;
    }

    .form-item label {
      margin-bottom: 6px;
      font-weight: 500;
      color: #333;
    }

    .form-item input[type="text"],
    .form-item input[type="number"],
    .form-item input[type="file"],
    .form-item input[type="button"] {
      padding: 10px 12px;
      border-radius: 6px;
      border: 1px solid #ccc;
      font-size: 14px;
      outline: none;
      transition: all 0.2s;
    }

    .form-item input[type="text"]:focus,
    .form-item input[type="number"]:focus {
      border-color: #ff7aa2;
      box-shadow: 0 0 5px rgba(255, 122, 162, 0.3);
    }

    .form-item select {
      padding: 10px 12px;
      border-radius: 6px;
      border: 1px solid #ccc;
      font-size: 14px;
      outline: none;
      transition: all 0.2s;
      background: #fff;
      margin-bottom: 0;
    }

    .form-item select:focus {
      border-color: #ff7aa2;
      box-shadow: 0 0 5px rgba(255, 122, 162, 0.3);
    }

    #add-stamp-btn {
      width: 100%;
      padding: 12px;
      border: none;
      border-radius: 8px;
      background-color: #ff7aa2;
      color: #fff;
      font-weight: bold;
      font-size: 16px;
      cursor: pointer;
      transition: background 0.2s;
    }

    #add-stamp-btn:hover {
      background-color: #ff6090;
    }

    /* ëª¨ë‹¬ ë°°ê²½ */
    .modal {
      display: none;
      position: fixed;
      z-index: 1000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.5);
      justify-content: center;
      align-items: center;
    }

    /* ëª¨ë‹¬ ì½˜í…ì¸  */
    .modal-content {
      background: #fff;
      padding: 16px;
      border-radius: 10px;
      width: 90%;
      max-width: 400px;
      max-height: 80%;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
    }

    .modal-header h3 {
      margin: 0;
      font-size: 16px;
      font-weight: 600;
      color: #333;
      flex: 1;
    }

    .modal-actions {
      display: flex;
      gap: 8px;
      align-items: center;
      justify-content: flex-end;
    }

    /* ë‹«ê¸° ë²„íŠ¼ */
    .close-btn {
      margin-left: 12px;
      font-size: 20px;
      cursor: pointer;
    }

    /* ì´ë¯¸ì§€ ê·¸ë¦¬ë“œ */
    .image-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 8px;
    }

    /* ì´ë¯¸ì§€ ì•„ì´í…œ */
    .image-item {
      width: 100%;
      padding-top: 100%;
      /* ì •ì‚¬ê°í˜• ìœ ì§€ */
      position: relative;
      background: #f0f0f0;
      border-radius: 8px;
      border: 8px solid #f0f0f0;
      overflow: hidden;
      cursor: pointer;
      margin: 2px;
    }

    .image-item img {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      object-fit: contain;
    }

    /* ì—…ë¡œë“œ ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
    .upload-item {
      display: flex;
      justify-content: center;
      align-items: center;
      font-size: 12px;
      color: #555;
      background: #e0e0e0;
      font-weight: bold;
    }

    /* ëª¨ë‹¬ ë²„íŠ¼(í—¤ë”) ìŠ¤íƒ€ì¼ [S]*/
    .modal-btn {
      padding: 6px 14px;
      border: none; 
      border-radius: 6px;
      background: #ffffff;
      color: #333;
      font-size: 14px;
      cursor: pointer;
      transition: background 0.2s;
    }

    .modal-btn:hover {
      background: #ff7aa2;
      color: #fff;
    }
    /* ëª¨ë‹¬ ë²„íŠ¼(í—¤ë”) ìŠ¤íƒ€ì¼ [E]*/

    .desc-textarea {
      padding: 10px 12px;
      border-radius: 6px;
      border: 1px solid #ccc;
      font-size: 14px;
      outline: none;
      transition: all 0.2s;
      resize: none;
      font-family: inherit;
    }

    .desc-textarea:focus {
      border-color: #ff7aa2;
      box-shadow: 0 0 5px rgba(255, 122, 162, 0.3);
    }

    /* ë¡œë”©ë°” [S] */
    .image-grid-loading {
      grid-column: 1 / -1;
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 100px;
    }

    .spinner {
      width: 40px;
      height: 40px;
      border: 4px solid #eee;
      border-top: 4px solid #ff7aa2;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      to {
        transform: rotate(360deg);
      }
    }
    /* ë¡œë”©ë°” [E] */
  </style>
</head>

<body>

  <!-- ìƒë‹¨ ë©”ë‰´ -->
  <header>
    <div class="header-left">Goal stamp</div>
  </header>
  <div class="add-stamp-page page">
    <h2>ìƒˆ ë‹¬ì„±í‘œ ì¶”ê°€</h2>

    <div class="form-item">
      <label for="stamp-name">ë‹¬ì„±í‘œëª…</label>
      <input type="text" id="stamp-name" name="stamp_nm" placeholder="ì˜ˆ: 7ì¼ ë‹¬ì„±í‘œ">
    </div>

    <div class="form-item">
      <label for="stamp-count">ê°œìˆ˜</label>
      <select id="stamp-count">
        <option value="7">7ê°œ</option>
        <option value="30">30ê°œ</option>
        <option value="50">50ê°œ</option>
        <option value="100">100ê°œ</option>
        <option value="custom">ì§ì ‘ ì…ë ¥</option>
      </select>
      <input type="number" id="stamp-count-custom" placeholder="ì§ì ‘ ì…ë ¥(1~100)" style="display:none; margin-top:8px;"
        min="1" max="100">
    </div>

    <div class="form-item">
      <label for="stamp-type">ë‹¬ì„±í‘œ ìœ í˜•</label>
      <select id="stamp-type" name="stamp_type">
        <option value="basic">ë‹¬ì„±í˜•(ë‚ ì§œì— ê´€ê³„ì—†ì´ ëª©í‘œë¥¼ ì™„ìˆ˜)</option>
        <option value="routine">ê·œì¹™í˜•(ë§¤ì¼ í•˜ë£¨ í•˜ë‚˜ì”©)</option>
      </select>
    </div>

    <div class="form-item">
      <label for="stamp-desc">ì„¤ëª…</label>
      <textarea id="stamp-desc" name="stamp_desc" rows="2" class="desc-textarea" maxlength="200" placeholder="ìŠ¤íƒ¬í”„ ì„¤ëª…(~200ì)"></textarea>
    </div>

    <div class="form-item">
      ì´ë¯¸ì§€ ë“±ë¡ (ë‹¬ì„± ì „)
      <!-- ì´ë¯¸ì§€ ë“±ë¡ ë²„íŠ¼ -->
      <div id="open-before-image-modal" class="thumbnail" >ì´ë¯¸ì§€ ì„ íƒ</div>
      <input type="hidden" id="before-image-id" name="before_image_id" value="">
    </div>

    <div class="form-item">
      ì´ë¯¸ì§€ ë“±ë¡ (ë‹¬ì„± í›„)
      <div id="open-after-image-modal" class="thumbnail" >ì´ë¯¸ì§€ ì„ íƒ</div>
      <input type="hidden" id="after-image-id" name="after_image_id" value="">
    </div>

    <button id="add-stamp-btn">ì¶”ê°€</button>
  </div>

  <!-- ì´ë¯¸ì§€ ëª¨ë‹¬ -->
  <div id="image-modal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3>ì´ë¯¸ì§€ ì„ íƒ</h3>
        <div class="modal-actions">
          <button type="button" id="modal-add-btn" class="modal-btn" title="ì¶”ê°€" aria-label="ì¶”ê°€">â•</button>
          <button type="button" id="modal-delete-btn" class="modal-btn" title="ì‚­ì œ" aria-label="ì‚­ì œ">ğŸ—‘ï¸</button>
          <button type="button" id="modal-close-btn" class="modal-btn" title="ë‹«ê¸°" aria-label="ë‹«ê¸°">âŒ</button>
        </div>
      </div>
      <div class="image-grid" style="display:none;">
      </div>
      <div class="image-grid-loading">
        <div class="spinner"></div>
      </div>
    </div>
  </div>

  <!-- í•˜ë‹¨ ë„¤ë¹„ê²Œì´ì…˜ -->
  <nav class="bottom-nav">
    <button class="nav-item active" onclick="location.href='./index.html'">
      <span>ğŸ </span>
      <span class="label">í™ˆ</span>
    </button>
    <button class="nav-item" onclick="location.href='./statistics.html'">
      <span>ğŸ“Š</span>
      <span class="label">í†µê³„</span>
    </button>
    <button class="nav-item" onclick="location.href='./setting.html'">
      <span>âš™ï¸</span>
      <span class="label">ì„¤ì •</span>
    </button>
  </nav>

  <div class="alert-modal" id="alert-modal" style="display:none;">
    <div class="alert-content">
        <p id="alert-message">íŒì—… ì˜ˆì‹œ.</p>
        <button id="alert-close">í™•ì¸</button>
    </div>
  </div>
  <script>
    const modal = document.getElementById("image-modal");
    const openBeforeBtn = document.getElementById("open-before-image-modal");
    const openAfterBtn = document.getElementById("open-after-image-modal");
    const closeBtn = document.getElementById("modal-close-btn");

    openBeforeBtn.addEventListener("click", () => {
      modal.style.display = "flex";
      reloadImageGrid('before'); // ëª¨ë‹¬ ê·¸ë¦¬ê¸° 
    });

    openAfterBtn.addEventListener("click", () => {
      modal.style.display = "flex";
      reloadImageGrid('after'); // ëª¨ë‹¬ ê·¸ë¦¬ê¸° 
    });

    function selectFile(obj, imageType, imageId){
      if (imageType === 'before') {
        document.getElementById("before-image-id").value = imageId;
        const thumbnail = openBeforeBtn;
        thumbnail.style.backgroundImage = `url('${obj.src}')`;
        thumbnail.textContent = ''; // ê¸°ë³¸ í…ìŠ¤íŠ¸ ì œê±°
      } else if (imageType === 'after') {
        document.getElementById("after-image-id").value = imageId;
        const thumbnail = openAfterBtn;
        thumbnail.style.backgroundImage = `url('${obj.src}')`;
        thumbnail.textContent = ''; // ê¸°ë³¸ í…ìŠ¤íŠ¸ ì œê±°
      }
      modal.style.display = "none";
    }

    // ì´ë¯¸ì§€ ì¶”ê°€ ë²„íŠ¼ í´ë¦­ ì‹œ 
    function uploadFile(imageType){ 
      const fileInput = document.createElement("input");
      fileInput.type = "file";
      fileInput.accept = "image/*";
      fileInput.style.display = "none";
      document.body.appendChild(fileInput);

      fileInput.addEventListener("change", (e) => onChangeFile(e, imageType));

      fileInput.click();
    }

    // ì„ íƒí•œ ì´ë¯¸ì§€ s3ì— ë°”ë¡œ ì—…ë¡œë“œ 
    function onChangeFile(e, imageType){
        const file = e.target.files[0];

        const formData = new FormData();
        formData.append("file", file);
        formData.append("is_public", false);
        formData.append("image_type", imageType);
        
        document.querySelector(".image-grid-loading").style.display = "grid";
        document.querySelector(".image-grid").style.display = "none";

        formFetch(`${ctx}/stamp-image`, 
        {method: 'PUT', 
          body: formData
        }).then((res) => {
          // ì—…ë¡œë“œ ì„±ê³µ í›„ ì²˜ë¦¬
          if (res.code === 200) {
            showAlert('ì´ë¯¸ì§€ê°€ ì„±ê³µì ìœ¼ë¡œ ì—…ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤.');
            reloadImageGrid(imageType);
          } else {
            showAlert('ì´ë¯¸ì§€ ì—…ë¡œë“œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
          }
        });
    }

    // ëª¨ë‹¬ì— ì´ë¯¸ì§€ í‘œì‹œ
    function reloadImageGrid(imageType){
      const imageGrid = document.querySelector(".image-grid");
      imageGrid.style.display = "grid";
      imageGrid.innerHTML = ""; // ê¸°ì¡´ ë‚´ìš© ì´ˆê¸°í™”
      apiFetch(`${ctx}/stamp-image?image_type=${imageType}`, 'GET')
        .then(data => {
          document.querySelector(".image-grid-loading").style.display = "none";
          document.getElementById("modal-add-btn").onclick = () => uploadFile(imageType);
          data.forEach(img => {
            const imgItem = document.createElement("div");
            imgItem.classList.add("image-item");
            imgItem.innerHTML = `<img src="${img.image_key}" alt="" onclick="selectFile(this, '${imageType}', '${img.image_id}')">`;
            imageGrid.appendChild(imgItem);
          });
        })
        .catch(error => {
          console.error('Error:', error);
          showAlert('ì„œë²„ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ë‚˜ì¤‘ì— ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
        });
    }

    closeBtn.addEventListener("click", () => {
      modal.style.display = "none";
    });

    // ëª¨ë‹¬ ë°”ê¹¥ í´ë¦­ ì‹œ ë‹«ê¸°
    window.addEventListener("click", (e) => {
      if (e.target === modal) modal.style.display = "none";
    });

    // selectì—ì„œ 'ì§ì ‘ ì…ë ¥' ì„ íƒ ì‹œ input í‘œì‹œ
    const stampCountSelect = document.getElementById('stamp-count');
    const stampCountCustom = document.getElementById('stamp-count-custom');
    stampCountSelect.addEventListener('change', function () {
      if (this.value === 'custom') {
        stampCountCustom.style.display = 'block';
      } else {
        stampCountCustom.style.display = 'none';
      }
    });

    // ì¶”ê°€ ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸ 
    document.querySelector('#add-stamp-btn').addEventListener('click', () => {
      const stampName = document.getElementById('stamp-name').value;
      const stampCount = stampCountSelect.value === 'custom' ? stampCountCustom.value : stampCountSelect.value;
      const stampType = document.getElementById('stamp-type').value;
      const stampDesc = document.getElementById('stamp-desc').value;
      const beforeImageId = document.getElementById('before-image-id').value;
      const afterImageId = document.getElementById('after-image-id').value;

      // ì…ë ¥ê°’ ê²€ì¦
      if (!stampName) {
        alert('ë‹¬ì„±í‘œëª…ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
        return;
      }
      if (!stampCount || isNaN(stampCount) || stampCount < 1 || stampCount > 100) {
        alert('ìœ íš¨í•œ ê°œìˆ˜ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš” (1~100).');
        return;
      }

      // JSON ë°ì´í„° ìƒì„±
      const reqData = {
        stamp_nm: stampName,
        total_cnt: stampCount,
        stamp_type: stampType,
        stamp_desc: stampDesc,
        before_image_id: beforeImageId,
        after_image_id: afterImageId
      };

      // ì„œë²„ë¡œ ì „ì†¡ 
      apiFetch(`${ctx}/stamp`, {
        method: 'POST',
        body: JSON.stringify(reqData)
      })
        .then(data => {
          if (data.code === 200) {
            showAlert('ë‹¬ì„±í‘œê°€ ì„±ê³µì ìœ¼ë¡œ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤!', ()=>{
              window.location.href = './index.html'; // í™ˆìœ¼ë¡œ ì´ë™
            });
            
          } else {
            showAlert('ë‹¬ì„±í‘œ ì¶”ê°€ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
          }
        })
        .catch(error => {
          console.error('Error:', error);
          showAlert('ì„œë²„ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ë‚˜ì¤‘ì— ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
        });
    });
  </script>

</body>

</html>