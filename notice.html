<!DOCTYPE html>
<html lang="ko">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Goal Tracker</title>
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
  <link rel="stylesheet" href="./css/default.css">
  <script type="text/javascript" src="./js/common.js"></script>
</head>

<body>

  <!-- ìƒë‹¨ ë©”ë‰´ -->
  <header>
    <div class="header-left">Goal Tracker</div>
  </header>

  <div class="list-container">
    <!-- í† ê¸€ ë²„íŠ¼ -->
    <div class="list-header">
    </div>
    <div class="list">
    </div>
    <!-- ì•Œë¦¼ ëª©ë¡ ì—†ì„ ë•Œ -->
    <div class="list empty" style="display:none;">
      <div class="empty-message">
        <span class="empty-icon">ğŸ“„</span>
        <span>ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</span>
      </div>
    </div>
  </div>
  
  <div class="alert-modal" id="alert-modal" style="display:none;">
    <div class="alert-content">
        <p id="alert-message">íŒì—… ì˜ˆì‹œ.</p>
        <button id="alert-close" onclick="hideAlert()">í™•ì¸</button>
    </div>
  </div>

  <!-- í•˜ë‹¨ ë„¤ë¹„ê²Œì´ì…˜ -->
  <nav class="bottom-nav">
    <button class="nav-item active" onclick="location.href='./index.html'">
      <span>ğŸ </span>
      <span class="label">í™ˆ</span>
    </button>
    <button class="nav-item" onclick="location.href='./setting.html'">
      <span>âš™ï¸</span>
      <span class="label">ì„¤ì •</span>
    </button>
  </nav>

  <script>
    const skipCount = 0;
    const limitCount = 20;

    // document.ready 
    document.addEventListener('DOMContentLoaded', function () {
      console.log('Document is ready with vanilla JavaScript!');
      callNoticeList();
      readAllNotices();
    });

    function callNoticeList(){
      apiFetch(`${ctx}/notice/list?skip=${skipCount}&limit=${limitCount}`, {
            method: 'GET',
        })
        .then(data => {
          console.log(data);
          drawNoticeList(data);
        })
        .catch(error => {
          console.error('Error:', error);
          showAlert("ì•Œë¦¼ ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨í•˜ì˜€ìŠµë‹ˆë‹¤.", () =>{
            location.href = './index.html';
          });
          return;
        });
    }

    // ìŠ¤íƒ¬í”„ ëª©ë¡ ê·¸ë¦¬ê¸° 
    function drawNoticeList(data){
      const listContainer = document.querySelector(".list");
      const emptyContainer = document.querySelector(".list.empty");

      // ê¸°ì¡´ ëª©ë¡ ì´ˆê¸°í™”
      listContainer.innerHTML = '';

      if (!data || data.length === 0) {
        emptyContainer.style.display = "flex";
        listContainer.style.display = "none";
        return;
      } else {
        emptyContainer.style.display = "none";
        listContainer.style.display = "block";
      }

      data.forEach(notice => {
        let html = `<div class="list-item" data-notice-id="${notice.notice_id}">`;
        if(notice.notice_type === 'friend_request'){
          html += `
            <div class="thumbnail info-icon">â„¹ï¸</div>
              <div class="info">
                <div class="title">${notice.notice_message}</div>
              </div>
              <button class="event-btn" data-goto="friend" aria-label="ë°”ë¡œê°€ê¸°"><span class="material-icons">arrow_forward</span></button>
              <button class="close-btn" aria-label="ì‚­ì œ"><span class="material-icons">close</span></button>
          `;
        } else if(notice.notice_type === 'friend_achieve'){
          html += `
            <div class="thumbnail achieve-icon">ğŸ†</div>
              <div class="info">
                <div class="title">${notice.notice_message}</div>
              </div>
              <button class="event-btn" aria-label="ì¢‹ì•„ìš”"><span class="material-icons">thumb_up</span></button>
              <button class="close-btn" aria-label="ì‚­ì œ"><span class="material-icons">close</span></button>
          `;
        } else{
          html += `
            <div class="thumbnail info-icon">â„¹ï¸</div>
              <div class="info">
                <div class="title">${notice.notice_message}</div>
              </div>
              <button class="close-btn" aria-label="ì‚­ì œ"><span class="material-icons">close</span></button>
          `;
        }
        html += `</div>`;
        listContainer.insertAdjacentHTML('beforeend', html);
        //const lastItem = listContainer.lastElementChild;
        //lastItem.querySelector(".thumbnail").style.backgroundImage = `url(${notice.image_url})`;
      });
    }

    // ì•Œë¦¼ ë³„ ë²„íŠ¼ í´ë¦­í–ˆì„ ì‹œ ì´ë²¤íŠ¸ ì²˜ë¦¬ 
    document.addEventListener('click', function(e) {
      const parent = e.target.parentElement;
      if (parent.classList.contains('event-btn')) {
        if(parent.dataset.goto === 'friend'){
          location.href = './friend.html';
          return;
        }

        parent.classList.toggle('clicked');
      }else if (parent.classList.contains('close-btn')) {
        apiFetch(`${ctx}/notice/`, {
            method: 'DELETE',
            body: JSON.stringify({
              notice_id: parent.closest('.list-item').dataset.noticeId
            })
        }).then(data => {
          console.log(data);
          if(data && data.code === 200){
            const listItem = parent.closest('.list-item');
            listItem.remove();
          } else {
            showAlert("ì•Œë¦¼ ì‚­ì œë¥¼ ì‹¤íŒ¨í•˜ì˜€ìŠµë‹ˆë‹¤.");
            return;
          }
        })
      }
    });

    // ì•Œë¦¼ í˜ì´ì§€ ì§„ì…í–ˆì„ ë•Œ ëª¨ë“  ì•Œë¦¼ì„ ì½ë„ë¡ ì²˜ë¦¬ 
    function readAllNotices(){
      apiFetch(`${ctx}/notice/read-all`, {
            method: 'POST',
        })
        .then(data => {
          console.log(data);
        })
        .catch(error => {
          console.error('ì•Œë¦¼ ì½ê¸° ì‹¤íŒ¨! Error:', error);
          return;
        });
    }

  </script>
</body>

</html>